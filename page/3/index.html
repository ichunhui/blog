<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ichunhui.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="不忘初心，方得始终.">
<meta property="og:type" content="website">
<meta property="og:title" content="Jimmy&#39;s Blog">
<meta property="og:url" content="https://ichunhui.github.io/page/3/index.html">
<meta property="og:site_name" content="Jimmy&#39;s Blog">
<meta property="og:description" content="不忘初心，方得始终.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jimmy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ichunhui.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Jimmy's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Jimmy's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jimmy's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">靡不有初，鲜克有终.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">192</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">114</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">41</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/ichunhui" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/200b00e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/200b00e.html" class="post-title-link" itemprop="url">Elasticsearch 排序</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-19 22:49:16" itemprop="dateCreated datePublished" datetime="2022-01-19T22:49:16+08:00">2022-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">搜索引擎数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/200b00e.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="200b00e.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="elasticsearch-排序"><a class="markdownIt-Anchor" href="#elasticsearch-排序"></a> Elasticsearch 排序</h1>
<p>在 Elasticsearch 中，默认排序是<strong>按照相关性的评分（_score）<strong>进行降序排序，也可以按照</strong>字段的值排序</strong>、<strong>多级排序</strong>、<strong>多值字段排序、基于 geo（地理位置）排序以及自定义脚本排序</strong>，除此之外，对于相关性的评分也可以用 rescore 二次、三次打分，它可以限定重新打分的窗口大小（window size），并针对作用范围内的文档修改其得分，从而达到精细化控制结果相关性的目的。</p>
<h2 id="1-默认相关性排序"><a class="markdownIt-Anchor" href="#1-默认相关性排序"></a> 1. 默认相关性排序</h2>
<p>在 Elasticsearch 中，默认情况下，文档是按照相关性得分倒序排列的，其对应的相关性得分字段用 <code>_score</code> 来表示，它是浮点数类型，<code>_score</code> 评分越高，相关性越高。评分模型的选择可以通过 <code>similarity</code> 参数在映射中指定。</p>
<p>相似度算法可以按字段指定，只需在映射中为不同字段选定即可，如果要修改已有字段的相似度算法，只能通过为数据重新建立索引来达到目的。关于更多 es 相似度算法可以参考 <a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-similarity.html">深入理解 es 相似度算法（相关性得分计算）</a>。</p>
<h3 id="11-tf-idf-模型"><a class="markdownIt-Anchor" href="#11-tf-idf-模型"></a> 1.1. TF-IDF 模型</h3>
<p>Elasticsearch 在 5.4 版本以前，text 类型的字段，默认采用基于 tf-idf 的向量空间模型。</p>
<p>在开始计算得分之时，Elasticsearch 使用了被搜索词条的频率以及它有多常见来影响得分。一个简短的解释是，<strong>一个词条出现在某个文档中的次数越多，它就越相关；但是，如果该词条出现在不同的文档的次数越多，它就越不相关</strong>。这一点被称为 TF-IDF，TF 是<strong>词频</strong>（term frequency），IDF 是<strong>逆文档频率</strong>（inverse document frequency）。</p>
<p>考虑给一篇文档打分的首要方式，是统计一个词条在文本中出现的次数。举个例子，如果在用户的区域搜索关于 Elasticsearch 的 get-together，用户希望频繁提及 Elasticsearch 的分组被优先展示出来。</p>
<figure class="highlight smalltalk"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot;We will discuss Elasticsearch at the next Big Data group.&quot;</span></span><br><span class="line"><span class="comment">&quot;Tuesday the Elasticsearch team will gather to answer questions about Elasticsearch.&quot;</span></span><br></pre></td></tr></table></figure>
<p>第一个句子提到 Elasticsearch 一次，而第二个句子提到 Elasticsearch 两次，所以包含第二句话的文档应该比包含第一句话的文档拥有更高的得分。如果我们要按照数量来讨论，第一句话的词频（TF）是 1，而第二句话的词频将是 2。</p>
<p>逆文档频率比文档词频稍微复杂一点。这个听上去很酷炫的描述意味着，如果一个分词（通常是单词，但不一定是）在索引的不同文档中出现越多的次数，那么它就越不重要。使用如下例子更容易解释这一点。</p>
<figure class="highlight smalltalk"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot;We use Elasticsearch to power the search for our website.&quot;</span></span><br><span class="line"><span class="comment">&quot;The developers like Elasticsearch so far.&quot;</span></span><br><span class="line"><span class="comment">&quot;The scoring of documents is calculated by the scoring formula.&quot;</span></span><br></pre></td></tr></table></figure>
<p>如上述例子，需要理解以下几点：</p>
<ul>
<li>词条 “Elasticsearch” 的文档频率是 2（因为它出现在两篇文档中）。文档频率的逆源自得分乘以 1/DF，这里 DF 是该词条的文档频率。这就意味着，由于词条拥有更高的文档频率，它的权重就会降低。</li>
<li>词条 “the” 的文档频率是 3，因为它出现在所有的三篇文档中。请注意，尽管 “the” 在最后一篇文档中出现了两次，它的文档频率还是 3。这是因为，逆文档频率只检查一个词条是否出现在某文档中，而不检查它出现多少次。那个应该是词频所关心的事情。</li>
</ul>
<p>逆文档频率是一个重要的因素，用于平衡词条的词频。举个例子，考虑有一个用户搜索词条 “the score”，单词 the 几乎出现在每个普通的英语文本中，如果它不被均衡一下，单词 the 的频率要完全淹没单词 score 的频率。逆文档频率 IDF 均衡了 the 这种常见词的相关性影响，所以实际的相关性得分将会对查询的词条有一个更准确的描述。</p>
<p>一旦词频 TF 和逆文档频率 IDF 计算完成，就可以使用 TF-IDF 公式来计算文档的得分。</p>
<h3 id="12-bm25-模型"><a class="markdownIt-Anchor" href="#12-bm25-模型"></a> 1.2. BM25 模型</h3>
<p>Elasticsearch 在 5.4 版本之后，针对 text 类型的字段，默认采用的是 BM25 评分模型，而不是基于 tf-idf 的向量空间模型，评分模型的选择可以通过 <code>similarity</code> 参数在映射中指定。</p>
<h2 id="2-字段的值排序"><a class="markdownIt-Anchor" href="#2-字段的值排序"></a> 2. 字段的值排序</h2>
<p>在 Elasticsearch 中按照字段的值排序，可以利用 <code>sort</code> 参数实现。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">132</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">749244</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;books&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8456479&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">8456479</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1580.00</span><span class="punctuation">,</span></span><br><span class="line">          ...</span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">1580.00</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      ...</span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>从如上返回结果，可以看出，<code>max_score</code> 和 <code>_score</code> 字段都返回 <code>null</code>，返回字段多出 <code>sort</code> 字段，包含排序字段的分值。计算 _<code>score</code> 的花销巨大，如果不根据相关性排序，记录 _<code>score</code> 是没有意义的。如果无论如何都要计算 _<code>score</code>，可以将 <code>track_scores</code> 参数设置为 <code>true</code>。</p>
<h2 id="3-多字段排序"><a class="markdownIt-Anchor" href="#3-多字段排序"></a> 3. 多字段排序</h2>
<p>如果我们想要结合使用 price、date 和 _score 进行查询，并且匹配的结果首先按照价格排序，然后按照日期排序，最后按照相关性排序，具体示例如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;content&quot;</span>: <span class="string">&quot;java&quot;</span> &#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;user_id&quot;</span>: 4868438 &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;sort&quot;</span>: [&#123;</span><br><span class="line">			<span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, &#123;</span><br><span class="line">			<span class="string">&quot;date&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, &#123;</span><br><span class="line">			<span class="string">&quot;_score&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>排序条件的顺序是很重要的。结果首先按第一个条件排序，仅当结果集的第一个 <code>sort</code> 值完全相同时才会按照第二个条件进行排序，以此类推。</p>
<p>多级排序并不一定包含 <code>_score</code>。你可以根据一些不同的字段进行排序，如地理距离或是脚本计算的特定值。</p>
<h2 id="4-多值字段的排序"><a class="markdownIt-Anchor" href="#4-多值字段的排序"></a> 4. 多值字段的排序</h2>
<p>一种情形是字段有多个值的排序，需要记住这些值并没有固有的顺序；一个多值的字段仅仅是多个值的包装，这时应该选择哪个进行排序呢？</p>
<p>对于数字或日期，你可以将多值字段减为单值，这可以通过使用 <code>min</code>、<code>max</code>、<code>avg</code> 或是 <code>sum</code> 排序模式。例如你可以按照每个 date 字段中的最早日期进行排序，通过以下方法：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dates&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;min&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="5-地理位置上的距离排序"><a class="markdownIt-Anchor" href="#5-地理位置上的距离排序"></a> 5. 地理位置上的距离排序</h2>
<p>es 的地理位置排序使用 <strong><code>_geo_distance</code></strong> 来进行距离排序，如下示例：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;_geo_distance&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;es_location_field&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">116.407526</span><span class="punctuation">,</span> <span class="number">39.904030</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;unit&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;km&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;min&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;distance_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;plane&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    ......</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><em>_geo_distance</em> 的选项具体如下：</p>
<ul>
<li>如上的 <em>es_location_field</em> 指的是 es 存储经纬度数据的字段名。</li>
<li><strong><em><code>order</code></em></strong>：指定按距离升序或降序，分别对应 <strong><em><code>asc</code></em></strong> 和 <strong><em><code>desc</code></em></strong>。</li>
<li><strong><em><code>unit</code></em></strong>：计算距离值的单位，默认是 <strong><em><code>m</code></em></strong>，表示米（meters），其它可选项有 <strong><em><code>mi</code></em></strong>、<strong><em><code>cm</code></em></strong>、<strong><em><code>mm</code></em></strong>、<strong><em><code>NM</code></em></strong>、<strong><em><code>km</code></em></strong>、<strong><em><code>ft</code></em></strong>、<strong><em><code>yd</code></em></strong> 和 <strong><em><code>in</code></em></strong>。</li>
<li><strong><em><code>mode</code></em></strong>：针对数组数据（多个值）时，指定的取值模式，可选值有 <strong><em><code>min</code></em></strong>、<strong><em><code>max</code></em></strong>、<strong><em><code>sum</code></em></strong>、<strong><em><code>avg</code></em></strong> 和 <strong><em><code>median</code></em></strong>，当排序采用升序时，默认为 <em>min</em>；排序采用降序时，默认为 <em>max</em>。</li>
<li><strong><em><code>distance_type</code></em></strong>：用来设置如何计算距离，它的可选项有 <strong><em><code>sloppy_arc</code></em></strong>、<strong><em><code>arc</code></em></strong> 和 <strong><em><code>plane</code></em></strong>，默认为 <em>sloppy_arc</em>，<em>arc</em> 它相对更精确些，但速度会明显下降，<em>plane</em> 则是计算快，但是长距离计算相对不准确。</li>
<li><strong><em><code>ignore_unmapped</code></em></strong>：未映射字段时，是否忽略处理，可选项有 <strong><em><code>true</code></em></strong> 和 <strong><em><code>false</code></em></strong>；默认为 <em>false</em>，表示如果未映射字段，查询将引发异常；若设置 <em>true</em>，将忽略未映射的字段，并且不匹配此查询的任何文档。</li>
<li><strong><em><code>validation_method</code></em></strong>：指定检验经纬度数据的方式，可选项有 <strong><em><code>IGNORE_MALFORMED</code></em></strong>、<strong><em><code>COERCE</code></em></strong> 和 <strong><em><code>STRICT</code></em></strong>；<em>IGNORE_MALFORMED</em> 表示可接受纬度或经度无效的地理点，即忽略数据；<em>COERCE</em> 表示另外尝试并推断正确的地理坐标；<em>STRICT</em> 为默认值，表示遇到不正确的地理坐标直接抛出异常。</li>
</ul>
<h2 id="6-参考资料"><a class="markdownIt-Anchor" href="#6-参考资料"></a> 6. 参考资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-intro.html">Elasticsearch 教程</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/8ee137cb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/8ee137cb.html" class="post-title-link" itemprop="url">Elasticsearch 聚合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-19 22:49:16" itemprop="dateCreated datePublished" datetime="2022-01-19T22:49:16+08:00">2022-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">搜索引擎数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/8ee137cb.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="8ee137cb.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="elasticsearch-聚合"><a class="markdownIt-Anchor" href="#elasticsearch-聚合"></a> Elasticsearch 聚合</h1>
<p>Elasticsearch 是一个分布式的全文搜索引擎，索引和搜索是 Elasticsearch 的基本功能。事实上，Elasticsearch 的聚合（Aggregations）功能也十分强大，允许在数据上做复杂的分析统计。Elasticsearch 提供的聚合分析功能主要有<strong>指标聚合(metrics aggregations)</strong>、<strong>桶聚合(bucket aggregations)</strong>、<strong>管道聚合(pipeline aggregations)</strong> 和 <strong>矩阵聚合(matrix aggregations)</strong> 四大类，管道聚合和矩阵聚合官方说明是在试验阶段，后期会完全更改或者移除，这里不再对管道聚合和矩阵聚合进行讲解。</p>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#1-%E8%81%9A%E5%90%88%E7%9A%84%E5%85%B7%E4%BD%93%E7%BB%93%E6%9E%84">1. 聚合的具体结构</a></li>
<li><a href="#2-%E6%8C%87%E6%A0%87%E8%81%9A%E5%90%88">2. 指标聚合</a>
<ul>
<li><a href="#21-max-aggregation">2.1. Max Aggregation</a></li>
<li><a href="#22-min-aggregation">2.2. Min Aggregation</a></li>
<li><a href="#23-avg-aggregation">2.3. Avg Aggregation</a></li>
<li><a href="#24-sum-aggregation">2.4. Sum Aggregation</a></li>
<li><a href="#25-value-count-aggregation">2.5. Value Count Aggregation</a></li>
<li><a href="#26-cardinality-aggregation">2.6. Cardinality Aggregation</a></li>
<li><a href="#27-stats-aggregation">2.7. Stats Aggregation</a></li>
<li><a href="#28-extended-stats-aggregation">2.8. Extended Stats Aggregation</a></li>
<li><a href="#29-percentiles-aggregation">2.9. Percentiles Aggregation</a></li>
<li><a href="#210-percentiles-ranks-aggregation">2.10. Percentiles Ranks Aggregation</a></li>
</ul>
</li>
<li><a href="#3-%E6%A1%B6%E8%81%9A%E5%90%88">3. 桶聚合</a>
<ul>
<li><a href="#31-terms-aggregation">3.1. Terms Aggregation</a></li>
<li><a href="#32-filter-aggregation">3.2. Filter Aggregation</a></li>
<li><a href="#33-filters-aggregation">3.3. Filters Aggregation</a></li>
<li><a href="#34-range-aggregation">3.4. Range Aggregation</a></li>
</ul>
</li>
<li><a href="#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">4. 参考资料</a></li>
</ul>
<!-- /TOC -->
<h2 id="1-聚合的具体结构"><a class="markdownIt-Anchor" href="#1-聚合的具体结构"></a> 1. 聚合的具体结构</h2>
<p>所有的聚合，无论它们是什么类型，都遵从以下的规则。</p>
<ul>
<li>使用查询中同样的 JSON 请求来定义它们，而且你是使用键 aggregations 或者是 aggs 来进行标记。需要给每个聚合起一个名字，指定它的类型以及和该类型相关的选项。</li>
<li>它们运行在查询的结果之上。和查询不匹配的文档不会计算在内，除非你使用 global 聚集将不匹配的文档囊括其中。</li>
<li>可以进一步过滤查询的结果，而不影响聚集。</li>
</ul>
<p>以下是聚合的基本结构：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> &lt;!-- 最外层的聚合键，也可以缩写为 aggs --&gt;</span><br><span class="line">    <span class="attr">&quot;&lt;aggregation_name&gt;&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> &lt;!-- 聚合的自定义名字 --&gt;</span><br><span class="line">        <span class="attr">&quot;&lt;aggregation_type&gt;&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> &lt;!-- 聚合的类型，指标相关的，如 max、min、avg、sum，桶相关的 terms、filter 等 --&gt;</span><br><span class="line">            &lt;aggregation_body&gt; &lt;!-- 聚合体：对哪些字段进行聚合，可以取字段的值，也可以是脚本计算的结果 --&gt;</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">[</span><span class="punctuation">,</span><span class="attr">&quot;meta&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>  <span class="punctuation">[</span>&lt;meta_data_body&gt;<span class="punctuation">]</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span>? &lt;!-- 元 --&gt;</span><br><span class="line">        <span class="punctuation">[</span><span class="punctuation">,</span><span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">[</span>&lt;sub_aggregation&gt;<span class="punctuation">]</span>+ <span class="punctuation">&#125;</span> <span class="punctuation">]</span>? &lt;!-- 在聚合里面在定义子聚合 --&gt;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">[</span><span class="punctuation">,</span><span class="attr">&quot;&lt;aggregation_name_2&gt;&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> ... <span class="punctuation">&#125;</span> <span class="punctuation">]</span>* &lt;!-- 聚合的自定义名字 <span class="number">2</span> --&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>在最上层有一个 aggregations 的键，可以缩写为 aggs</strong>。</li>
<li>在下面一层，需要为聚合指定一个名字。可以在请求的返回中看到这个名字。在同一个请求中使用多个聚合时，这一点非常有用，它让你可以很容易地理解每组结果的含义。</li>
<li>最后，必须要指定聚合的类型。</li>
</ul>
<blockquote>
<p>关于聚合分析的值来源，可以<strong>取字段的值</strong>，也可以是<strong>脚本计算的结果</strong>。</p>
<p>但是用脚本计算的结果时，需要注意脚本的性能和安全性；尽管多数聚集类型允许使用脚本，但是脚本使得聚集变得缓慢，因为脚本必须在每篇文档上运行。为了避免脚本的运行，可以在索引阶段进行计算。</p>
<p>此外，脚本也可以被人可能利用进行恶意代码攻击，尽量使用沙盒（sandbox）内的脚本语言。</p>
</blockquote>
<p>示例：查询所有球员的平均年龄是多少，并对球员的平均薪水加 188（也可以理解为每名球员加 188 后的平均薪水）。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST /player/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avg_age&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;avg_salary_188&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;source&quot;</span>: <span class="string">&quot;doc.salary.value + 188&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-指标聚合"><a class="markdownIt-Anchor" href="#2-指标聚合"></a> 2. 指标聚合</h2>
<p>指标聚合（又称度量聚合）主要从不同文档的分组中提取统计数据，或者，从来自其他聚合的文档桶来提取统计数据。</p>
<p>这些统计数据通常来自数值型字段，如最小或者平均价格。用户可以单独获取每项统计数据，或者也可以使用 stats 聚合来同时获取它们。更高级的统计数据，如平方和或者是标准差，可以通过 extended stats 聚合来获取。</p>
<h3 id="21-max-aggregation"><a class="markdownIt-Anchor" href="#21-max-aggregation"></a> 2.1. Max Aggregation</h3>
<p>Max Aggregation 用于最大值统计。例如，统计 sales 索引中价格最高的是哪本书，并且计算出对应的价格的 2 倍值，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /sales/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;max_price&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;max&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_price_2&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;max&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;source&quot;</span>: <span class="string">&quot;_value * 2.0&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>指定的 field，在脚本中可以用 _value 取字段的值</strong>。</p>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 188.0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_price_2&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 376.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="22-min-aggregation"><a class="markdownIt-Anchor" href="#22-min-aggregation"></a> 2.2. Min Aggregation</h3>
<p>Min Aggregation 用于最小值统计。例如，统计 sales 索引中价格最低的是哪本书，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /sales/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;min_price&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;min&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;min_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 18.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="23-avg-aggregation"><a class="markdownIt-Anchor" href="#23-avg-aggregation"></a> 2.3. Avg Aggregation</h3>
<p>Avg Aggregation 用于计算平均值。例如，统计 exams 索引中考试的平均分数，如未存在分数，默认为 60 分，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /exams/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;avg_grade&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;grade&quot;</span>,</span><br><span class="line">        <span class="string">&quot;missing&quot;</span>: 60</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果指定字段没有值，可以通过 missing 指定默认值；若未指定默认值，缺失该字段值的文档将被忽略（计算）</strong>。</p>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avg_grade&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 78.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了常规的平均值聚合计算外，elasticsearch 还提供了加权平均值的聚合计算，详情参见 <a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-aggregations-metrics-weighted-avg-aggregation.html">Elasticsearch 指标聚合之 Weighted Avg Aggregation</a>。</p>
<h3 id="24-sum-aggregation"><a class="markdownIt-Anchor" href="#24-sum-aggregation"></a> 2.4. Sum Aggregation</h3>
<p>Sum Aggregation 用于计算总和。例如，统计 sales 索引中 type 字段中匹配 hat 的价格总和，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /exams/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;hat&quot;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;hat_prices&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;sum&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;price&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;hat_prices&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 567.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="25-value-count-aggregation"><a class="markdownIt-Anchor" href="#25-value-count-aggregation"></a> 2.5. Value Count Aggregation</h3>
<p>Value Count Aggregation 可按字段统计文档数量。例如，统计 books 索引中包含 author 字段的文档数量，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /books/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;doc_count&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;value_count&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;author&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;doc_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="26-cardinality-aggregation"><a class="markdownIt-Anchor" href="#26-cardinality-aggregation"></a> 2.6. Cardinality Aggregation</h3>
<p>Cardinality Aggregation 用于基数统计，其作用是先执行类似 SQL 中的 distinct 操作，去掉集合中的重复项，然后统计去重后的集合长度。例如，在 books 索引中对 language 字段进行 cardinality 操作可以统计出编程语言的种类数，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /books/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;all_lan&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;language&quot;</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;title_cnt&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;title.keyword&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>假设 title 字段为文本类型（text），去重时需要指定 keyword，表示把 title 作为整体去重，即不分词统计</strong>。</p>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;all_lan&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;title_cnt&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 18</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="27-stats-aggregation"><a class="markdownIt-Anchor" href="#27-stats-aggregation"></a> 2.7. Stats Aggregation</h3>
<p>Stats Aggregation 用于基本统计，会一次返回 count、max、min、avg 和 sum 这 5 个指标。例如，在 exams 索引中对 grade 字段进行分数相关的基本统计，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /exams/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;grades_stats&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;stats&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;grade&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;grades_stats&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;count&quot;</span>: 2,</span><br><span class="line">      <span class="string">&quot;min&quot;</span>: 50.0,</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: 100.0,</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: 75.0,</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: 150.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="28-extended-stats-aggregation"><a class="markdownIt-Anchor" href="#28-extended-stats-aggregation"></a> 2.8. Extended Stats Aggregation</h3>
<p>Extended Stats Aggregation 用于高级统计，和基本统计功能类似，但是会比基本统计多出以下几个统计结果，sum_of_squares（平方和）、variance（方差）、std_deviation（标准差）、std_deviation_bounds（平均值加/减两个标准差的区间）。在 exams 索引中对 grade 字段进行分数相关的高级统计，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> /exams/_search?<span class="attribute">size</span>=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;grades_stats&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;extended_stats&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;grade&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>聚合结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;grades_stats&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;count&quot;</span>: 2,</span><br><span class="line">      <span class="string">&quot;min&quot;</span>: 50.0,</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: 100.0,</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: 75.0,</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: 150.0,</span><br><span class="line">      <span class="string">&quot;sum_of_squares&quot;</span>: 12500.0,</span><br><span class="line">      <span class="string">&quot;variance&quot;</span>: 625.0,</span><br><span class="line">      <span class="string">&quot;std_deviation&quot;</span>: 25.0,</span><br><span class="line">      <span class="string">&quot;std_deviation_bounds&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;upper&quot;</span>: 125.0,</span><br><span class="line">        <span class="string">&quot;lower&quot;</span>: 25.0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="29-percentiles-aggregation"><a class="markdownIt-Anchor" href="#29-percentiles-aggregation"></a> 2.9. Percentiles Aggregation</h3>
<p>Percentiles Aggregation 用于百分位统计。百分位数是一个统计学术语，如果将一组数据从大到小排序，并计算相应的累计百分位，某一百分位所对应数据的值就称为这一百分位的百分位数。默认情况下，累计百分位为 [ 1, 5, 25, 50, 75, 95, 99 ]。以下例子给出了在 latency 索引中对 load_time 字段进行加载时间的百分位统计，查询语句如下：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">GET latency/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;load_time_outlier&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;percentiles&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : &quot;<span class="type">load_time</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>需要注意的是，如上的 <code>load_time</code> 字段必须是数字类型</strong>。</p>
<p>聚合结果如下：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;load_time_outlier&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;values&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;1.0&quot;</span>: <span class="number">5.0</span>,</span><br><span class="line">        <span class="string">&quot;5.0&quot;</span>: <span class="number">25.0</span>,</span><br><span class="line">        <span class="string">&quot;25.0&quot;</span>: <span class="number">165.0</span>,</span><br><span class="line">        <span class="string">&quot;50.0&quot;</span>: <span class="number">445.0</span>,</span><br><span class="line">        <span class="string">&quot;75.0&quot;</span>: <span class="number">725.0</span>,</span><br><span class="line">        <span class="string">&quot;95.0&quot;</span>: <span class="number">945.0</span>,</span><br><span class="line">        <span class="string">&quot;99.0&quot;</span>: <span class="number">985.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>百分位的统计也可以指定 percents 参数指定百分位，如下：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">GET latency/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;load_time_outlier&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;percentiles&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : &quot;<span class="type">load_time</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">        &quot;</span>percents<span class="string">&quot;: [60, 80, 95]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="210-percentiles-ranks-aggregation"><a class="markdownIt-Anchor" href="#210-percentiles-ranks-aggregation"></a> 2.10. Percentiles Ranks Aggregation</h3>
<p>Percentiles Ranks Aggregation 与 Percentiles Aggregation 统计恰恰相反，就是想看当前数值处在什么范围内（百分位）， 假如你查一下当前值 500 和 600 所处的百分位，发现是 90.01 和 100，那么说明有 90.01 % 的数值都在 500 以内，100 % 的数值在 600 以内。</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">GET latency/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;load_time_ranks&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;percentile_ranks&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;field&quot;</span> : &quot;<span class="type">load_time</span><span class="string">&quot;,</span></span><br><span class="line"><span class="string">          &quot;</span>values<span class="string">&quot; : [500, 600]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong><code>同样 load_time</code> 字段必须是数字类型</strong>。</p>
<p>返回结果大概类似如下：</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;load_time_ranks&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;values&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;500.0&quot;</span>: <span class="number">90.01</span>,</span><br><span class="line">        <span class="string">&quot;600.0&quot;</span>: <span class="number">100.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以设置 <code>keyed</code> 参数为 <code>true</code>，将对应的 values 作为桶 key 一起返回，默认是 <code>false</code>。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> latency/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;load_time_ranks&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;percentile_ranks&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;load_time&quot;</span>,</span><br><span class="line">        <span class="string">&quot;values&quot;</span>: [500, 600],</span><br><span class="line">        <span class="string">&quot;keyed&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果如下：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;load_time_ranks&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;values&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="number">500.0</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="number">90.01</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="number">600.0</span>,</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="number">100.0</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-桶聚合"><a class="markdownIt-Anchor" href="#3-桶聚合"></a> 3. 桶聚合</h2>
<p>bucket 可以理解为一个桶，它会遍历文档中的内容，凡是符合某一要求的就放入一个桶中，分桶相当于 SQL 中的 group by。从另外一个角度，可以将指标聚合看成单桶聚合，即把所有文档放到一个桶中，而桶聚合是多桶型聚合，它根据相应的条件进行分组。</p>
<table>
<thead>
<tr>
<th style="text-align:left">种类</th>
<th style="text-align:left">描述/场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">词项聚合（Terms Aggregation）</td>
<td style="text-align:left">用于分组聚合，让用户得知文档中每个词项的频率，它返回每个词项出现的次数。</td>
</tr>
<tr>
<td style="text-align:left">差异词项聚合（Significant Terms Aggregation）</td>
<td style="text-align:left">它会返回某个词项在整个索引中和在查询结果中的词频差异，这有助于我们发现搜索场景中有意义的词。</td>
</tr>
<tr>
<td style="text-align:left">过滤器聚合（Filter Aggregation）</td>
<td style="text-align:left">指定过滤器匹配的所有文档到单个桶（bucket），通常这将用于将当前聚合上下文缩小到一组特定的文档。</td>
</tr>
<tr>
<td style="text-align:left">多过滤器聚合（Filters Aggregation）</td>
<td style="text-align:left">指定多个过滤器匹配所有文档到多个桶（bucket）。</td>
</tr>
<tr>
<td style="text-align:left">范围聚合（Range Aggregation）</td>
<td style="text-align:left">范围聚合，用于反映数据的分布情况。</td>
</tr>
<tr>
<td style="text-align:left">日期范围聚合（Date Range Aggregation）</td>
<td style="text-align:left">专门用于日期类型的范围聚合。</td>
</tr>
<tr>
<td style="text-align:left">IP 范围聚合（IP Range Aggregation）</td>
<td style="text-align:left">用于对 IP 类型数据范围聚合。</td>
</tr>
<tr>
<td style="text-align:left">直方图聚合（Histogram Aggregation）</td>
<td style="text-align:left">可能是数值，或者日期型，和范围聚集类似。</td>
</tr>
<tr>
<td style="text-align:left">时间直方图聚合（Date Histogram Aggregation）</td>
<td style="text-align:left">时间直方图聚合，常用于按照日期对文档进行统计并绘制条形图。</td>
</tr>
<tr>
<td style="text-align:left">空值聚合（Missing Aggregation）</td>
<td style="text-align:left">空值聚合，可以把文档集中所有缺失字段的文档分到一个桶中。</td>
</tr>
<tr>
<td style="text-align:left">地理点范围聚合（Geo Distance Aggregation）</td>
<td style="text-align:left">用于对地理点（geo point）做范围统计。</td>
</tr>
</tbody>
</table>
<h3 id="31-terms-aggregation"><a class="markdownIt-Anchor" href="#31-terms-aggregation"></a> 3.1. Terms Aggregation</h3>
<p>Terms Aggregation 用于词项的分组聚合。最为经典的用例是获取 X 中最频繁（top frequent）的项目，其中 X 是文档中的某个字段，如用户的名称、标签或分类。由于 terms 聚集统计的是每个词条，而不是整个字段值，因此通常需要在一个非分析型的字段上运行这种聚集。原因是, 你期望“big data”作为词组统计，而不是“big”单独统计一次，“data”再单独统计一次。</p>
<p>用户可以使用 terms 聚集，从分析型字段（如内容）中抽取最为频繁的词条。还可以使用这种信息来生成一个单词云。</p>
<figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;profit_terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123; <span class="comment">// terms 聚合 关键字</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;profit&quot;</span>,</span><br><span class="line">        <span class="params">...</span><span class="params">...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 terms 分桶的基础上，还可以对每个桶进行指标统计，也可以基于一些指标或字段值进行排序。示例如下：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;item_terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;item_id&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="string">&quot;order&quot;</span>:[&#123;</span><br><span class="line">          <span class="string">&quot;gmv_stat&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">        &#125;,&#123;</span><br><span class="line">          <span class="string">&quot;gmv_180d&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">        &#125;]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gmv_stat&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;sum&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gmv&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;gmv_180d&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;sum&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;script&quot;</span>: <span class="string">&quot;doc[&#x27;gmv_90d&#x27;].value*2&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的结果如下：</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;hospital_id_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;doc_count_error_upper_bound&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;sum_other_doc_count&quot;</span>: 260,</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 23388,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 18,</span><br><span class="line">          <span class="string">&quot;gmv_stat&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: 176220</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;gmv_180d&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: 89732</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 96117,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 16,</span><br><span class="line">          <span class="string">&quot;gmv_stat&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: 129306</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;gmv_180d&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: 56988</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">...</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下返回按文档计数从高到低的前 10 个分组，可以通过 size 参数指定返回的分组数。</p>
<h3 id="32-filter-aggregation"><a class="markdownIt-Anchor" href="#32-filter-aggregation"></a> 3.2. Filter Aggregation</h3>
<p>Filter Aggregation 是过滤器聚合，可以把符合过滤器中的条件的文档分到一个桶中，即是单分组聚合。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_terms&quot;: &#123;</span><br><span class="line">      &quot;<span class="attribute">filter</span>&quot;: &#123;&quot;match&quot;:&#123;&quot;gender&quot;:<span class="string">&quot;F&quot;</span>&#125;&#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_age&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: <span class="string">&quot;age&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="33-filters-aggregation"><a class="markdownIt-Anchor" href="#33-filters-aggregation"></a> 3.3. Filters Aggregation</h3>
<p>Filters Aggregation 是多过滤器聚合，可以把符合多个过滤条件的文档分到不同的桶中，即每个分组关联一个过滤条件，并收集所有满足自身过滤条件的文档。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    &quot;messages&quot;: &#123;</span><br><span class="line">      &quot;filters&quot;: &#123;</span><br><span class="line">        &quot;filters&quot;: &#123;</span><br><span class="line">          &quot;errors&quot;: &#123; &quot;match&quot;: &#123; &quot;<span class="selector-tag">body</span>&quot;: <span class="string">&quot;error&quot;</span> &#125; &#125;,</span><br><span class="line">          &quot;warnings&quot;: &#123; &quot;match&quot;: &#123; &quot;<span class="selector-tag">body</span>&quot;: <span class="string">&quot;warning&quot;</span> &#125; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子里，我们分析日志信息。聚合会创建两个关于日志数据的分组，一个收集包含错误信息的文档，另一个收集包含告警信息的文档。而且每个分组会按月份划分。</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;messages&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;errors&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;warnings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 2</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="34-range-aggregation"><a class="markdownIt-Anchor" href="#34-range-aggregation"></a> 3.4. Range Aggregation</h3>
<p>Range Aggregation 范围聚合是一个基于多组值来源的聚合，可以让用户定义一系列范围，每个范围代表一个分组。在聚合执行的过程中，从每个文档提取出来的值都会检查每个分组的范围，并且使相关的文档落入分组中。注意，范围聚合的每个范围内包含 from 值但是排除 to 值。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age_range&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ranges&quot;</span>: [&#123;</span><br><span class="line">            &quot;<span class="selector-tag">to</span>&quot;: <span class="number">25</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;<span class="selector-tag">from</span>&quot;: <span class="number">25</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="number">35</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;<span class="selector-tag">from</span>&quot;: <span class="number">35</span></span><br><span class="line">          &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;aggs&quot;: &#123;</span><br><span class="line">          &quot;bmax&quot;: &#123;</span><br><span class="line">            &quot;max&quot;: &#123;</span><br><span class="line">              &quot;field&quot;: <span class="string">&quot;balance&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果如下：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;*-25.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;to&quot;</span>: <span class="number">25</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span>: <span class="number">225</span>,</span><br><span class="line">        <span class="string">&quot;bmax&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="number">49587</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;25.0-35.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;from&quot;</span>: <span class="number">25</span>,</span><br><span class="line">        <span class="string">&quot;to&quot;</span>: <span class="number">35</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span>: <span class="number">485</span>,</span><br><span class="line">        <span class="string">&quot;bmax&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="number">49795</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;35.0-*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;from&quot;</span>: <span class="number">35</span>,</span><br><span class="line">        <span class="string">&quot;doc_count&quot;</span>: <span class="number">290</span>,</span><br><span class="line">        <span class="string">&quot;bmax&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;value&quot;</span>: <span class="number">49989</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-参考资料"><a class="markdownIt-Anchor" href="#4-参考资料"></a> 4. 参考资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-intro.html">Elasticsearch 教程</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/48cee716.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/48cee716.html" class="post-title-link" itemprop="url">Elasticsearch 查询</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-18 08:01:08" itemprop="dateCreated datePublished" datetime="2022-01-18T08:01:08+08:00">2022-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">搜索引擎数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/48cee716.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="48cee716.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>30 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="elasticsearch-查询"><a class="markdownIt-Anchor" href="#elasticsearch-查询"></a> Elasticsearch 查询</h1>
<p>Elasticsearch 查询语句采用基于 RESTful 风格的接口封装成 JSON 格式的对象，称之为 Query DSL。Elasticsearch 查询分类大致分为<strong>全文查询</strong>、<strong>词项查询</strong>、<strong>复合查询</strong>、<strong>嵌套查询</strong>、<strong>位置查询</strong>、<strong>特殊查询</strong>。Elasticsearch 查询从机制分为两种，一种是根据用户输入的查询词，通过排序模型计算文档与查询词之间的<strong>相关度</strong>，并根据评分高低排序返回；另一种是<strong>过滤机制</strong>，只根据过滤条件对文档进行过滤，不计算评分，速度相对较快。</p>
<h2 id="1-全文查询"><a class="markdownIt-Anchor" href="#1-全文查询"></a> 1. 全文查询</h2>
<p>ES 全文查询主要用于在全文字段上，主要考虑查询词与文档的相关性（Relevance）。</p>
<h3 id="11-intervals-query"><a class="markdownIt-Anchor" href="#11-intervals-query"></a> 1.1. intervals query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-intervals-query.html"><strong><code>intervals query</code></strong></a> 根据匹配词的顺序和近似度返回文档。</p>
<p>intervals query 使用<strong>匹配规则</strong>，这些规则应用于指定字段中的 term。</p>
<p>示例：下面示例搜索 <code>query</code> 字段，搜索值是 <code>my favorite food</code>，没有任何间隙；然后是 <code>my_text</code> 字段搜索匹配 <code>hot water</code>、<code>cold porridge</code> 的 term。</p>
<p>当 my_text 中的值为 <code>my favorite food is cold porridge</code> 时，会匹配成功，但是 <code>when it's cold my favorite food is porridge</code> 则匹配失败</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;intervals&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;my_text&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;all_of&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;ordered&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;intervals&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&quot;match&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;query&quot;</span> : <span class="string">&quot;my favorite food&quot;</span>,</span><br><span class="line">                <span class="string">&quot;max_gaps&quot;</span> : 0,</span><br><span class="line">                <span class="string">&quot;ordered&quot;</span> : <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&quot;any_of&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;intervals&quot;</span> : [</span><br><span class="line">                  &#123; <span class="string">&quot;match&quot;</span> : &#123; <span class="string">&quot;query&quot;</span> : <span class="string">&quot;hot water&quot;</span> &#125; &#125;,</span><br><span class="line">                  &#123; <span class="string">&quot;match&quot;</span> : &#123; <span class="string">&quot;query&quot;</span> : <span class="string">&quot;cold porridge&quot;</span> &#125; &#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="12-match-query"><a class="markdownIt-Anchor" href="#12-match-query"></a> 1.2. match query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html"><strong><code>match query</code></strong></a> <strong>用于搜索单个字段</strong>，首先会针对查询语句进行解析（经过 analyzer），主要是对查询语句进行分词，分词后查询语句的任何一个词项被匹配，文档就会被搜到，默认情况下相当于对分词后词项进行 or 匹配操作。</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html"><strong><code>match query</code></strong></a> 是执行全文搜索的标准查询，包括模糊匹配选项。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;George Hubbard&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>等同于 <code>or</code> 匹配操作，如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;George Hubbard&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;or&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="match-query-简写"><a class="markdownIt-Anchor" href="#match-query-简写"></a> match query 简写</h4>
<p>可以通过组合 <code>&lt;field&gt;</code> 和 <code>query</code> 参数来简化匹配查询语法。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: <span class="string">&quot;this is a test&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="match-query-如何工作"><a class="markdownIt-Anchor" href="#match-query-如何工作"></a> match query 如何工作</h4>
<p>匹配查询是布尔类型。这意味着会对提供的文本进行分析，分析过程从提供的文本构造一个布尔查询。 <code>operator</code> 参数可以设置为 <code>or</code> 或 <code>and</code> 来控制布尔子句（默认为 <code>or</code>）。可以使用 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html"><code>minimum_should_match</code></a> 参数设置要匹配的可选 <code>should</code> 子句的最小数量。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;George Hubbard&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以设置 <code>analyzer</code> 来控制哪个分析器将对文本执行分析过程。它默认为字段显式映射定义或默认搜索分析器。</p>
<p><code>lenient</code> 参数可以设置为 <code>true</code> 以忽略由数据类型不匹配导致的异常，例如尝试使用文本查询字符串查询数字字段。默认为 <code>false</code>。</p>
<h4 id="match-query-的模糊查询"><a class="markdownIt-Anchor" href="#match-query-的模糊查询"></a> match query 的模糊查询</h4>
<p><code>fuzziness</code> 允许基于被查询字段的类型进行模糊匹配。请参阅 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#fuzziness">Fuzziness</a> 的配置。</p>
<p>在这种情况下可以设置 <code>prefix_length</code> 和 <code>max_expansions</code> 来控制模糊匹配。如果设置了模糊选项，查询将使用 <code>top_terms_blended_freqs_$&#123;max_expansions&#125;</code> 作为其重写方法，<code>fuzzy_rewrite</code> 参数允许控制查询将如何被重写。</p>
<p>默认情况下允许模糊倒转 (<code>ab</code> → <code>ba</code>)，但可以通过将 <code>fuzzy_transpositions</code> 设置为 <code>false</code> 来禁用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;this is a testt&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fuzziness&quot;</span>: <span class="string">&quot;AUTO&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="zero-terms-查询"><a class="markdownIt-Anchor" href="#zero-terms-查询"></a> zero terms 查询</h4>
<p>如果使用的分析器像 stop 过滤器一样删除查询中的所有标记，则默认行为是不匹配任何文档。可以使用 <code>zero_terms_query</code> 选项来改变默认行为，它接受 <code>none</code>（默认）和 <code>all</code> （相当于 <code>match_all</code> 查询）。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;to be or not to be&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zero_terms_query&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-match_bool_prefix-query"><a class="markdownIt-Anchor" href="#13-match_bool_prefix-query"></a> 1.3. match_bool_prefix query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-bool-prefix-query.html"><strong><code>match_bool_prefix query</code></strong></a> 分析其输入并根据这些词构造一个布尔查询。除了最后一个术语之外的每个术语都用于术语查询。最后一个词用于 <code>prefix query</code>。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_bool_prefix&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span> : <span class="string">&quot;quick brown f&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;message&quot;</span>: <span class="string">&quot;quick&quot;</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;message&quot;</span>: <span class="string">&quot;brown&quot;</span> &#125;&#125;,</span><br><span class="line">        &#123; <span class="string">&quot;prefix&quot;</span>: &#123; <span class="string">&quot;message&quot;</span>: <span class="string">&quot;f&quot;</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>match_bool_prefix query</code> 和 <code>match_phrase_prefix query</code> 之间的一个重要区别是：<code>match_phrase_prefix query</code> 将其 term 匹配为短语，但 <code>match_bool_prefix query</code> 可以在任何位置匹配其 term。</p>
<p>上面的示例 <code>match_bool_prefix query</code> 查询可以匹配包含 <code>quick brown fox</code> 的字段，但它也可以快速匹配 <code>brown fox</code>。它还可以匹配包含 <code>quick</code>、<code>brown</code> 和以 <code>f</code> 开头的字段，出现在任何位置。</p>
<h3 id="14-match_phrase-query"><a class="markdownIt-Anchor" href="#14-match_phrase-query"></a> 1.4. match_phrase query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase.html"><strong><code>match_phrase query</code></strong></a> 即短语匹配，首先会把 query 内容分词，分词器可以自定义，同时文档还要满足以下两个条件才会被搜索到：</p>
<ol>
<li><strong>分词后所有词项都要出现在该字段中（相当于 and 操作）</strong>。</li>
<li><strong>字段中的词项顺序要一致</strong>。</li>
</ol>
<p>例如，有以下 3 个文档，使用 <strong><code>match_phrase</code></strong> 查询 “How are you”，只有前两个文档会被匹配：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT demo/_create/1</span><br><span class="line">&#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;How are you&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">PUT demo/_create/2</span><br><span class="line">&#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;How are you, Jack?&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">PUT demo/_create/3</span><br><span class="line">&#123; <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;are you&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">GET demo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;How are you&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：</p>
<p>一个被认定为和短语 How are you 匹配的文档，必须满足以下这些要求：</p>
<ul>
<li>How、 are 和 you 需要全部出现在域中。</li>
<li>are 的位置应该比 How 的位置大 1 。</li>
<li>you 的位置应该比 How 的位置大 2 。</li>
</ul>
</blockquote>
<h3 id="15-match_phrase_prefix-query"><a class="markdownIt-Anchor" href="#15-match_phrase_prefix-query"></a> 1.5. match_phrase_prefix query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase-prefix.html"><strong><code>match_phrase_prefix query</code></strong></a> 和 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase.html"><strong><code>match_phrase query</code></strong></a> 类似，只不过 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase-prefix.html"><strong><code>match_phrase_prefix query</code></strong></a> 最后一个 term 会被作为前缀匹配。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET demo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase_prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;are yo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="16-multi_match-query"><a class="markdownIt-Anchor" href="#16-multi_match-query"></a> 1.6. multi_match query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html"><strong><code>multi_match query</code></strong></a> 是 <strong><code>match query</code></strong> 的升级，<strong>用于搜索多个字段</strong>。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: 34.98,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;taxful_total_price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;taxless_total_price&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>multi_match query</code></strong> 的搜索字段可以使用通配符指定，示例如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: 34.98,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;taxful_*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;taxless_total_price&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，也可以用<strong>指数符指定搜索字段的权重</strong>。</p>
<p>示例：指定 taxful_total_price 字段的权重是 taxless_total_price 字段的 3 倍，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: 34.98,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;taxful_total_price^3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;taxless_total_price&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-combined_fields-query"><a class="markdownIt-Anchor" href="#17-combined_fields-query"></a> 1.7. combined_fields query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-combined-fields-query.html"><strong><code>combined_fields query</code></strong></a> 支持搜索多个文本字段，就好像它们的内容已被索引到一个组合字段中一样。该查询会生成以 term 为中心的输入字符串视图：首先它将查询字符串解析为独立的 term，然后在所有字段中查找每个 term。当匹配结果可能跨越多个文本字段时，此查询特别有用，例如文章的标题、摘要和正文：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;combined_fields&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>:      <span class="string">&quot;database systems&quot;</span>,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>:     [ <span class="string">&quot;title&quot;</span>, <span class="string">&quot;abstract&quot;</span>, <span class="string">&quot;body&quot;</span>],</span><br><span class="line">      <span class="string">&quot;operator&quot;</span>:   <span class="string">&quot;and&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="字段前缀权重"><a class="markdownIt-Anchor" href="#字段前缀权重"></a> 字段前缀权重</h4>
<p>字段前缀权重根据组合字段模型进行计算。例如，如果 title 字段的权重为 2，则匹配度打分时会将 title 中的每个 term 形成的组合字段，按出现两次进行打分。</p>
<h3 id="18-common_terms-query"><a class="markdownIt-Anchor" href="#18-common_terms-query"></a> 1.8. common_terms query</h3>
<blockquote>
<p>7.3.0 废弃</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-common-terms-query.html"><strong><code>common_terms query</code></strong></a> 是一种在不牺牲性能的情况下替代停用词提高搜索准确率和召回率的方案。</p>
<p>查询中的每个词项都有一定的代价，以搜索“The brown fox”为例，query 会被解析成三个词项“the”“brown”和“fox”，每个词项都会到索引中执行一次查询。很显然包含“the”的文档非常多，相比其他词项，“the”的重要性会低很多。传统的解决方案是把“the”当作停用词处理，去除停用词之后可以减少索引大小，同时在搜索时减少对停用词的收缩。</p>
<p>虽然停用词对文档评分影响不大，但是当停用词仍然有重要意义的时候，去除停用词就不是完美的解决方案了。如果去除停用词，就无法区分“happy”和“not happy”, “The”“To be or not to be”就不会在索引中存在，搜索的准确率和召回率就会降低。</p>
<p>common_terms query 提供了一种解决方案，它把 query 分词后的词项分成重要词项（低频词项）和不重要的词项（高频词，也就是之前的停用词）。在搜索的时候，首先搜索和重要词项匹配的文档，这些文档是词项出现较少并且词项对其评分影响较大的文档。然后执行第二次查询，搜索对评分影响较小的高频词项，但是不计算所有文档的评分，而是只计算第一次查询已经匹配的文档得分。如果一个查询中只包含高频词，那么会通过 and 连接符执行一个单独的查询，换言之，会搜索所有的词项。</p>
<p>词项是高频词还是低频词是通过 cutoff frequency 来设置阀值的，取值可以是绝对频率（频率大于 1）或者相对频率（0 ～ 1）。common_terms query 最有趣之处在于它能自适应特定领域的停用词，例如，在视频托管网站上，诸如“clip”或“video”之类的高频词项将自动表现为停用词，无须保留手动列表。</p>
<p>例如，文档频率高于 0.1% 的词项将会被当作高频词项，词频之间可以用 low_freq_operator、high_freq_operator 参数连接。设置低频词操作符为“and”使所有的低频词都是必须搜索的，示例代码如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;common&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;body&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;query&quot;</span>: <span class="string">&quot;nelly the elephant as a cartoon&quot;</span>,</span><br><span class="line">				<span class="string">&quot;cutoff_frequency&quot;</span>: 0.001,</span><br><span class="line">				<span class="string">&quot;low_freq_operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述操作等价于：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: [</span><br><span class="line">			  &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;nelly&quot;</span> &#125; &#125;,</span><br><span class="line">			  &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;elephant&quot;</span> &#125; &#125;,</span><br><span class="line">			  &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;cartoon&quot;</span> &#125; &#125;</span><br><span class="line">			],</span><br><span class="line">			<span class="string">&quot;should&quot;</span>: [</span><br><span class="line">			  &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;the&quot;</span> &#125; &#125;,</span><br><span class="line">			  &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;as&quot;</span> &#125; &#125;,</span><br><span class="line">			  &#123; <span class="string">&quot;term&quot;</span>: &#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;a&quot;</span> &#125; &#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="19-query_string-query"><a class="markdownIt-Anchor" href="#19-query_string-query"></a> 1.9. query_string query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html"><strong><code>query_string query</code></strong></a> 是与 Lucene 查询语句的语法结合非常紧密的一种查询，允许在一个查询语句中使用多个特殊条件关键字（如：AND | OR | NOT）对多个字段进行查询，建议熟悉 Lucene 查询语法的用户去使用。</p>
<p>用户可以使用 query_string query 来创建包含通配符、跨多个字段的搜索等复杂搜索。虽然通用，但查询是严格的，如果查询字符串包含任何无效语法，则会返回错误。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;(new york city) OR (big apple)&quot;</span>,</span><br><span class="line">      <span class="string">&quot;default_field&quot;</span>: <span class="string">&quot;content&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="110-simple_query_string-query"><a class="markdownIt-Anchor" href="#110-simple_query_string-query"></a> 1.10. simple_query_string query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-simple-query-string-query.html"><strong><code>simple_query_string query</code></strong></a> 是一种适合直接暴露给用户，并且具有非常完善的查询语法的查询语句，接受 Lucene 查询语法，解析过程中发生错误不会抛出异常。</p>
<p>虽然语法比 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html"><strong><code>query_string query</code></strong></a> 更严格，但 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-simple-query-string-query.html"><strong><code>simple_query_string query</code></strong></a> 不会返回无效语法的错误。相反，它会忽略查询字符串的任何无效部分。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;simple_query_string&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;\&quot;fried eggs\&quot; +(eggplant | potato) -frittata&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;title^5&quot;</span>, <span class="string">&quot;body&quot;</span>],</span><br><span class="line">        <span class="string">&quot;default_operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="simple_query_string-语义"><a class="markdownIt-Anchor" href="#simple_query_string-语义"></a> simple_query_string 语义</h4>
<ul>
<li><code>+</code>：等价于 AND 操作</li>
<li><code>|</code>：等价于 OR 操作</li>
<li><code>-</code>：相当于 NOT 操作</li>
<li><code>&quot;</code>：包装一些标记以表示用于搜索的短语</li>
<li><code>*</code>：词尾表示前缀查询</li>
<li><code>(</code> and <code>)</code>：表示优先级</li>
<li><code>~N</code>：词尾表示表示编辑距离（模糊性）</li>
<li><code>~N</code>：在一个短语之后表示溢出量</li>
</ul>
<p>注意：要使用上面的字符，请使用反斜杠 <code>/</code> 对其进行转义。</p>
<h3 id="111-全文查询完整示例"><a class="markdownIt-Anchor" href="#111-全文查询完整示例"></a> 1.11. 全文查询完整示例</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#设置 position_increment_gap</span></span><br><span class="line">DELETE <span class="built_in">groups</span></span><br><span class="line">PUT <span class="built_in">groups</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;position_increment_gap&quot;</span>: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET <span class="built_in">groups</span>/_mapping</span><br><span class="line"></span><br><span class="line">POST <span class="built_in">groups</span>/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;names&quot;</span>: [ <span class="string">&quot;John Water&quot;</span>, <span class="string">&quot;Water Smith&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST <span class="built_in">groups</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Water Water&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slop&quot;</span>: 100</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST <span class="built_in">groups</span>/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>: <span class="string">&quot;Water Smith&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE <span class="built_in">groups</span></span><br></pre></td></tr></table></figure>
<h2 id="2-词项查询"><a class="markdownIt-Anchor" href="#2-词项查询"></a> 2. 词项查询</h2>
<p><strong><code>Term</code>（词项）是表达语意的最小单位</strong>。搜索和利用统计语言模型进行自然语言处理都需要处理 Term。</p>
<p>全文查询在执行查询之前会分析查询字符串。</p>
<p>与全文查询不同，词项查询不会分词，而是将输入作为一个整体，在倒排索引中查找准确的词项。并且使用相关度计算公式为每个包含该词项的文档进行相关度计算。一言以概之：<strong>词项查询是对词项进行精确匹配</strong>。词项查询通常用于结构化数据，如数字、日期和枚举类型。</p>
<p>词项查询有以下类型：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-exists-query.html"><code>exists</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-fuzzy-query.html"><code>fuzzy</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-ids-query.html"><code>ids</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-prefix-query.html"><code>prefix</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html"><code>range</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html"><code>regexp</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><code>term</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-terms-query.html"><code>terms</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-type-query.html"><code>type</code> query</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html"><code>wildcard</code> query</a></strong></li>
</ul>
<h3 id="21-exists-query"><a class="markdownIt-Anchor" href="#21-exists-query"></a> 2.1. exists query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-exists-query.html"><strong><code>exists query</code></strong></a> 会返回字段中至少有一个非空值的文档。</p>
<p>由于多种原因，文档字段可能不存在索引值：</p>
<ul>
<li>JSON 中的字段为 <code>null</code> 或 <code>[]</code></li>
<li>该字段在 mapping 中配置了 <code>&quot;index&quot; : false</code></li>
<li>字段值的长度超过了 mapping 中的 <code>ignore_above</code> 设置</li>
<li>字段值格式错误，并且在 mapping 中定义了 <code>ignore_malformed</code></li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;field&quot;</span>: <span class="string">&quot;email&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下文档会匹配上面的查询：</p>
<ul>
<li><code>&#123; &quot;user&quot; : &quot;jane&quot; &#125;</code> 有 user 字段，且不为空。</li>
<li><code>&#123; &quot;user&quot; : &quot;&quot; &#125;</code> 有 user 字段，值为空字符串。</li>
<li><code>&#123; &quot;user&quot; : &quot;-&quot; &#125;</code> 有 user 字段，值不为空。</li>
<li><code>&#123; &quot;user&quot; : [ &quot;jane&quot; ] &#125;</code> 有 user 字段，值不为空。</li>
<li><code>&#123; &quot;user&quot; : [ &quot;jane&quot;, null ] &#125;</code> 有 user 字段，至少一个值不为空即可。</li>
</ul>
<p>下面的文档都不会被匹配：</p>
<ul>
<li><code>&#123; &quot;user&quot; : null &#125;</code> 虽然有 user 字段，但是值为空。</li>
<li><code>&#123; &quot;user&quot; : [] &#125;</code> 虽然有 user 字段，但是值为空。</li>
<li><code>&#123; &quot;user&quot; : [null] &#125;</code> 虽然有 user 字段，但是值为空。</li>
<li><code>&#123; &quot;foo&quot; : &quot;bar&quot; &#125;</code> 没有 user 字段。</li>
</ul>
<h3 id="22-fuzzy-query"><a class="markdownIt-Anchor" href="#22-fuzzy-query"></a> 2.2. fuzzy query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-fuzzy-query.html"><strong><code>fuzzy query</code></strong>（模糊查询）</a>返回包含与搜索词相似的词的文档。ES 使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein edit distance（Levenshtein 编辑距离）</a>测量相似度或模糊度。</p>
<p>编辑距离是将一个术语转换为另一个术语所需的单个字符更改的数量。这些变化可能包括：</p>
<ul>
<li>改变一个字符：（<strong>b</strong>ox -&gt; <strong>f</strong>ox）</li>
<li>删除一个字符：（<strong>b</strong>lack -&gt; lack）</li>
<li>插入一个字符：（sic -&gt; sic<strong>k</strong>）</li>
<li>反转两个相邻字符：（<strong>ac</strong>t → <strong>ca</strong>t）</li>
</ul>
<p>为了找到相似的词条，fuzzy query 会在指定的编辑距离内创建搜索词条的所有可能变体或扩展集。然后返回完全匹配任意扩展的文档。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;user.id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;ki&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fuzziness&quot;</span>: <span class="string">&quot;AUTO&quot;</span>,</span><br><span class="line">        <span class="string">&quot;max_expansions&quot;</span>: 50,</span><br><span class="line">        <span class="string">&quot;prefix_length&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;transpositions&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;rewrite&quot;</span>: <span class="string">&quot;constant_score&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：如果配置了 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries"><code>search.allow_expensive_queries</code></a> ，则 fuzzy query 不能执行。</p>
<h3 id="23-ids-query"><a class="markdownIt-Anchor" href="#23-ids-query"></a> 2.3. ids query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-ids-query.html"><strong><code>ids query</code></strong></a> 根据 ID 返回文档。 此查询使用存储在 <code>_id</code> 字段中的文档 ID。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;ids&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;values&quot;</span> : [<span class="string">&quot;1&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;100&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="24-prefix-query"><a class="markdownIt-Anchor" href="#24-prefix-query"></a> 2.4. prefix query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-prefix-query.html#prefix-query-ex-request"><strong><code>prefix query</code></strong></a> 用于查询某个字段中包含指定前缀的文档。</p>
<p>比如查询 <code>user.id</code> 中含有以 <code>ki</code> 为前缀的关键词的文档，那么含有 <code>kind</code>、<code>kid</code> 等所有以 <code>ki</code> 开头关键词的文档都会被匹配。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;user.id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;ki&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="25-range-query"><a class="markdownIt-Anchor" href="#25-range-query"></a> 2.5. range query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html"><strong><code>range query</code></strong></a> 即范围查询，用于匹配在某一范围内的数值型、日期类型或者字符串型字段的文档。比如搜索哪些书籍的价格在 50 到 100 之间、哪些书籍的出版时间在 2015 年到 2019 年之间。<strong>使用 range 查询只能查询一个字段，不能作用在多个字段上</strong>。</p>
<p>range 查询支持的参数有以下几种：</p>
<ul>
<li>
<p><strong><code>gt</code></strong>：大于</p>
</li>
<li>
<p><strong><code>gte</code></strong>：大于等于</p>
</li>
<li>
<p><strong><code>lt</code></strong>：小于</p>
</li>
<li>
<p><strong><code>lte</code></strong>：小于等于</p>
</li>
<li>
<p><strong><code>format</code></strong>：如果字段是 Date 类型，可以设置日期格式化</p>
</li>
<li>
<p><strong><code>time_zone</code></strong>：时区</p>
</li>
<li>
<p><strong><code>relation</code></strong>：指示范围查询如何匹配范围字段的值。</p>
<ul>
<li><strong><code>INTERSECTS</code> (Default)</strong>：匹配与查询字段值范围相交的文档。</li>
<li><strong><code>CONTAINS</code></strong>：匹配完全包含查询字段值的文档。</li>
<li><strong><code>WITHIN</code></strong>：匹配具有完全在查询范围内的范围字段值的文档。</li>
</ul>
</li>
</ul>
<p>示例：数值范围查询</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;taxful_total_price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gt&quot;</span>: 10,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: 50</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：日期范围查询</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;order_date&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;time_zone&quot;</span>: <span class="string">&quot;+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;2018-01-01T00:00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: <span class="string">&quot;now&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="26-regexp-query"><a class="markdownIt-Anchor" href="#26-regexp-query"></a> 2.6. regexp query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html"><strong><code>regexp query</code></strong></a> 返回与正则表达式相匹配的 term 所属的文档。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">正则表达式</a>是一种使用占位符字符匹配数据模式的方法，称为运算符。</p>
<p>示例：以下搜索返回 <code>user.id</code> 字段包含任何以 <code>k</code> 开头并以 <code>y</code> 结尾的文档。 <code>.*</code> 运算符匹配任何长度的任何字符，包括无字符。匹配项可以包括 <code>ky</code>、<code>kay</code> 和 <code>kimchy</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;user.id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;k.*y&quot;</span>,</span><br><span class="line">        <span class="string">&quot;flags&quot;</span>: <span class="string">&quot;ALL&quot;</span>,</span><br><span class="line">        <span class="string">&quot;case_insensitive&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;max_determinized_states&quot;</span>: 10000,</span><br><span class="line">        <span class="string">&quot;rewrite&quot;</span>: <span class="string">&quot;constant_score&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果配置了<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries"><code>search.allow_expensive_queries</code></a> ，则 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html"><strong><code>regexp query</code></strong></a> 会被禁用。</p>
</blockquote>
<h3 id="27-term-query"><a class="markdownIt-Anchor" href="#27-term-query"></a> 2.7. term query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><strong><code>term query</code></strong></a> 用来查找指定字段中包含给定单词的文档，term 查询不被解析，只有查询词和文档中的词精确匹配才会被搜索到，应用场景为查询人名、地名等需要精准匹配的需求。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个索引</span></span><br><span class="line">DELETE my-index-000001</span><br><span class="line">PUT my-index-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_text&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 使用 &quot;Quick Brown Foxes!&quot; 关键字查 &quot;full_text&quot; 字段</span></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;full_text&quot;</span>: <span class="string">&quot;Quick Brown Foxes!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用 term 查询</span></span><br><span class="line">GET my-index-000001/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_text&quot;</span>: <span class="string">&quot;Quick Brown Foxes!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 因为 full_text 字段不再包含确切的 Term —— &quot;Quick Brown Foxes!&quot;，所以 term query 搜索不到任何结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 使用 match 查询</span></span><br><span class="line">GET my-index-000001/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_text&quot;</span>: <span class="string">&quot;Quick Brown Foxes!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE my-index-000001</span><br></pre></td></tr></table></figure>
<blockquote>
<p>⚠️ 注意：应避免 term 查询对 text 字段使用查询。</p>
<p>默认情况下，Elasticsearch 针对 text 字段的值进行解析分词，这会使查找 text 字段值的精确匹配变得困难。</p>
<p>要搜索 text 字段值，需改用 match 查询。</p>
</blockquote>
<h3 id="28-terms-query"><a class="markdownIt-Anchor" href="#28-terms-query"></a> 2.8. terms query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-terms-query.html"><strong><code>terms query</code></strong></a> 与 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><strong><code>term query</code></strong></a> 相同，但可以搜索多个值。</p>
<p>terms query 查询参数：</p>
<ul>
<li><strong><code>index</code></strong>：索引名</li>
<li><strong><code>id</code></strong>：文档 ID</li>
<li><strong><code>path</code></strong>：要从中获取字段值的字段的名称，即搜索关键字</li>
<li><strong><code>routing</code></strong>（选填）：要从中获取 term 值的文档的自定义路由值。如果在索引文档时提供了自定义路由值，则此参数是必需的。</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个索引</span></span><br><span class="line">DELETE my-index-000001</span><br><span class="line">PUT my-index-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;color&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 写入一个文档</span></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;color&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;blue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;green&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 写入另一个文档</span></span><br><span class="line">PUT my-index-000001/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;color&quot;</span>: <span class="string">&quot;blue&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用 terms query</span></span><br><span class="line">GET my-index-000001/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;color&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;my-index-000001&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: <span class="string">&quot;color&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE my-index-000001</span><br></pre></td></tr></table></figure>
<h3 id="29-type-query"><a class="markdownIt-Anchor" href="#29-type-query"></a> 2.9. type query</h3>
<blockquote>
<p>7.0.0 后废弃</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-type-query.html"><strong><code>type query</code></strong></a> 用于查询具有指定类型的文档。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: <span class="string">&quot;_doc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="210-wildcard-query"><a class="markdownIt-Anchor" href="#210-wildcard-query"></a> 2.10. wildcard query</h3>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html"><strong><code>wildcard query</code></strong></a> 即通配符查询，返回与通配符模式匹配的文档。</p>
<p><code>?</code> 用来匹配一个任意字符，<code>*</code> 用来匹配零个或者多个字符。</p>
<p>示例：以下搜索返回 <code>user.id</code> 字段包含以 <code>ki</code> 开头并以 <code>y</code> 结尾的术语的文档。这些匹配项可以包括 <code>kiy</code>、<code>kity</code> 或 <code>kimchy</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;user.id&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;ki*y&quot;</span>,</span><br><span class="line">        <span class="string">&quot;boost&quot;</span>: 1.0,</span><br><span class="line">        <span class="string">&quot;rewrite&quot;</span>: <span class="string">&quot;constant_score&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果配置了<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries"><code>search.allow_expensive_queries</code></a> ，则<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html"><strong><code>wildcard query</code></strong></a> 会被禁用。</p>
</blockquote>
<h3 id="211-词项查询完整示例"><a class="markdownIt-Anchor" href="#211-词项查询完整示例"></a> 2.11. 词项查询完整示例</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span>: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: 1 &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;productID&quot;</span> : <span class="string">&quot;XHDK-A-1293-#fJ3&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;iPhone&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: 2 &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;productID&quot;</span> : <span class="string">&quot;KDKE-B-9947-#kL5&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;iPad&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: 3 &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;productID&quot;</span> : <span class="string">&quot;JODL-X-1937-#pV7&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;MBP&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">GET /products</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;desc&quot;</span>: &#123;</span><br><span class="line">        //<span class="string">&quot;value&quot;</span>: <span class="string">&quot;iPhone&quot;</span></span><br><span class="line">        <span class="string">&quot;value&quot;</span>:<span class="string">&quot;iphone&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;desc.keyword&quot;</span>: &#123;</span><br><span class="line">        //<span class="string">&quot;value&quot;</span>: <span class="string">&quot;iPhone&quot;</span></span><br><span class="line">        //<span class="string">&quot;value&quot;</span>:<span class="string">&quot;iphone&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;productID&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;XHDK-A-1293-#fJ3&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  //<span class="string">&quot;explain&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;productID.keyword&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;XHDK-A-1293-#fJ3&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;explain&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;productID.keyword&quot;</span>: <span class="string">&quot;XHDK-A-1293-#fJ3&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-复合查询"><a class="markdownIt-Anchor" href="#3-复合查询"></a> 3. 复合查询</h2>
<p>复合查询就是把一些简单查询组合在一起实现更复杂的查询需求，除此之外，复合查询还可以控制另外一个查询的行为。</p>
<h3 id="31-bool-query"><a class="markdownIt-Anchor" href="#31-bool-query"></a> 3.1. bool query</h3>
<p>bool 查询可以把任意多个简单查询组合在一起，使用 must、should、must_not、filter 选项来表示简单查询之间的逻辑，每个选项都可以出现 0 次到多次，它们的含义如下：</p>
<ul>
<li>must 文档必须匹配 must 选项下的查询条件，相当于逻辑运算的 AND，且参与文档相关度的评分。</li>
<li>should 文档可以匹配 should 选项下的查询条件也可以不匹配，相当于逻辑运算的 OR，且参与文档相关度的评分。</li>
<li>must_not 与 must 相反，匹配该选项下的查询条件的文档不会被返回；需要注意的是，<strong>must_not 语句不会影响评分，它的作用只是将不相关的文档排除</strong>。</li>
<li>filter 和 must 一样，匹配 filter 选项下的查询条件的文档才会被返回，<strong>但是 filter 不评分，只起到过滤功能，与 must_not 相反</strong>。</li>
</ul>
<p>假设要查询 title 中包含关键词 java，并且 price 不能高于 70，description 可以包含也可以不包含虚拟机的书籍，构造 bool 查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;status&quot;</span>: 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;gte&quot;</span>: 70</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;虚拟机&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;minimum_should_match&quot;</span>: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有关布尔查询更详细的信息参考 <a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-query-bool.html">bool query（组合查询）详解</a>。</p>
<h3 id="32-boosting-query"><a class="markdownIt-Anchor" href="#32-boosting-query"></a> 3.2. boosting query</h3>
<p>boosting 查询用于需要对两个查询的评分进行调整的场景，boosting 查询会把两个查询封装在一起并降低其中一个查询的评分。</p>
<p>boosting 查询包括 positive、negative 和 negative_boost 三个部分，positive 中的查询评分保持不变，negative 中的查询会降低文档评分，negative_boost 指明 negative 中降低的权值。如果我们想对 2015 年之前出版的书降低评分，可以构造一个 boosting 查询，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;boosting&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;positive&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;title&quot;</span>: <span class="string">&quot;python&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;negative&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;publish_time&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;lte&quot;</span>: <span class="string">&quot;2015-01-01&quot;</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;negative_boost&quot;</span>: 0.2</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>boosting 查询中指定了抑制因子为 0.2，publish_time 的值在 2015-01-01 之后的文档得分不变，publish_time 的值在 2015-01-01 之前的文档得分为原得分的 0.2 倍。</p>
<h3 id="33-constant_score-query"><a class="markdownIt-Anchor" href="#33-constant_score-query"></a> 3.3. constant_score query</h3>
<p>constant<em>score query 包装一个 filter query，并返回匹配过滤器查询条件的文档，且它们的相关性评分都等于 _boost</em> 参数值（可以理解为原有的基于 tf-idf 或 bm25 的相关分固定为 1.0，所以最终评分为 <em>1.0 * boost</em>，即等于 <em>boost</em> 参数值）。下面的查询语句会返回 title 字段中含有关键词 <em>elasticsearch</em> 的文档，所有文档的评分都是 1.8：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: 1.8</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="34-dis_max-query"><a class="markdownIt-Anchor" href="#34-dis_max-query"></a> 3.4. dis_max query</h3>
<p>dis_max query 与 bool query 有一定联系也有一定区别，dis_max query 支持多并发查询，可返回与任意查询条件子句匹配的任何文档类型。与 bool 查询可以将所有匹配查询的分数相结合使用的方式不同，dis_max 查询只使用最佳匹配查询条件的分数。请看下面的例子：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;dis_max&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;tie_breaker&quot;</span>: 0.7,</span><br><span class="line">			<span class="string">&quot;boost&quot;</span>: 1.2,</span><br><span class="line">			<span class="string">&quot;queries&quot;</span>: [&#123;</span><br><span class="line">					<span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;age&quot;</span>: 34</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;age&quot;</span>: 35</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="35-function_score-query"><a class="markdownIt-Anchor" href="#35-function_score-query"></a> 3.5. function_score query</h3>
<p>function_score query 可以修改查询的文档得分，这个查询在有些情况下非常有用，比如通过评分函数计算文档得分代价较高，可以改用过滤器加自定义评分函数的方式来取代传统的评分方式。</p>
<p>使用 function_score query，用户需要定义一个查询和一至多个评分函数，评分函数会对查询到的每个文档分别计算得分。</p>
<p>下面这条查询语句会返回 books 索引中的所有文档，文档的最大得分为 5，每个文档的得分随机生成，权重的计算模式为相乘模式。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match all&quot;</span>: &#123;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;random_score&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;boost_mode&quot;</span>: <span class="string">&quot;multiply&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用脚本自定义评分公式，这里把 price 值的十分之一开方作为每个文档的得分，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;script_score&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;inline&quot;</span>: <span class="string">&quot;Math.sqrt(doc[&#x27;price&#x27;].value/10)&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 function_score 的更多详细内容请查看 <a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-function_score.html">Elasticsearch function_score 查询最强详解</a>。</p>
<h3 id="36-indices-query"><a class="markdownIt-Anchor" href="#36-indices-query"></a> 3.6. indices query</h3>
<p>indices query 适用于需要在多个索引之间进行查询的场景，它允许指定一个索引名字列表和内部查询。indices query 中有 query 和 no_match_query 两部分，query 中用于搜索指定索引列表中的文档，no_match_query 中的查询条件用于搜索指定索引列表之外的文档。下面的查询语句实现了搜索索引 books、books2 中 title 字段包含关键字 javascript，其他索引中 title 字段包含 basketball 的文档，查询语句如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;indices&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;indices&quot;</span>: [<span class="string">&quot;books&quot;</span>, <span class="string">&quot;books2&quot;</span>],</span><br><span class="line">			<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;title&quot;</span>: <span class="string">&quot;javascript&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;no_match_query&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;title&quot;</span>: <span class="string">&quot;basketball&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-嵌套查询"><a class="markdownIt-Anchor" href="#4-嵌套查询"></a> 4. 嵌套查询</h2>
<p>在 Elasticsearch 这样的分布式系统中执行全 SQL 风格的连接查询代价昂贵，是不可行的。相应地，为了实现水平规模地扩展，Elasticsearch 提供了以下两种形式的 join：</p>
<ul>
<li>
<p>nested query（嵌套查询）</p>
<p>文档中可能包含嵌套类型的字段，这些字段用来索引一些数组对象，每个对象都可以作为一条独立的文档被查询出来。</p>
</li>
<li>
<p>has_child query（有子查询）和 has_parent query（有父查询）</p>
<p>父子关系可以存在单个的索引的两个类型的文档之间。has_child 查询将返回其子文档能满足特定查询的父文档，而 has_parent 则返回其父文档能满足特定查询的子文档。</p>
</li>
</ul>
<h3 id="41-nested-query"><a class="markdownIt-Anchor" href="#41-nested-query"></a> 4.1. nested query</h3>
<p>文档中可能包含嵌套类型的字段，这些字段用来索引一些数组对象，每个对象都可以作为一条独立的文档被查询出来（用嵌套查询）。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;type1&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;obj1&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;type&quot;</span>: <span class="string">&quot;nested&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="42-has_child-query"><a class="markdownIt-Anchor" href="#42-has_child-query"></a> 4.2. has_child query</h3>
<p>文档的父子关系创建索引时在映射中声明，这里以员工（employee）和工作城市（branch）为例，它们属于不同的类型，相当于数据库中的两张表，如果想把员工和他们工作的城市关联起来，需要告诉 Elasticsearch 文档之间的父子关系，这里 employee 是 child type，branch 是 parent type，在映射中声明，执行命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /company</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;branch&quot;</span>: &#123;&#125;,</span><br><span class="line">		<span class="string">&quot;employee&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;parent&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;branch&quot;</span> &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 bulk api 索引 branch 类型下的文档，命令如下：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">POST company<span class="regexp">/branch/</span>_bulk</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;london&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;London Westminster&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;London&quot;</span>,<span class="string">&quot;country&quot;</span>: <span class="string">&quot;UK&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;liverpool&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Liverpool Central&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;Liverpool&quot;</span>,<span class="string">&quot;country&quot;</span>: <span class="string">&quot;UK&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;paris&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Champs Elysees&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;Paris&quot;</span>,<span class="string">&quot;country&quot;</span>: <span class="string">&quot;France&quot;</span> &#125;</span><br></pre></td></tr></table></figure>
<p>添加员工数据：</p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line">POST company/employee/_bulk</span><br><span class="line">&#123; &quot;<span class="keyword">index</span><span class="string">&quot;: &#123; &quot;</span>_id<span class="string">&quot;: 1,&quot;</span>parent<span class="string">&quot;:&quot;</span>london<span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>name<span class="string">&quot;: &quot;</span>Alice Smith<span class="string">&quot;,&quot;</span>dob<span class="string">&quot;: &quot;</span><span class="number">1970</span><span class="number">-10</span><span class="number">-24</span><span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;: &quot;</span>hiking<span class="string">&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">index</span><span class="string">&quot;: &#123; &quot;</span>_id<span class="string">&quot;: 2,&quot;</span>parent<span class="string">&quot;:&quot;</span>london<span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>name<span class="string">&quot;: &quot;</span>Mark Tomas<span class="string">&quot;,&quot;</span>dob<span class="string">&quot;: &quot;</span><span class="number">1982</span><span class="number">-05</span><span class="number">-16</span><span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;: &quot;</span>diving<span class="string">&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">index</span><span class="string">&quot;: &#123; &quot;</span>_id<span class="string">&quot;: 3,&quot;</span>parent<span class="string">&quot;:&quot;</span>liverpool<span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>name<span class="string">&quot;: &quot;</span>Barry Smith<span class="string">&quot;,&quot;</span>dob<span class="string">&quot;: &quot;</span><span class="number">1979</span><span class="number">-04</span><span class="number">-01</span><span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;: &quot;</span>hiking<span class="string">&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span><span class="keyword">index</span><span class="string">&quot;: &#123; &quot;</span>_id<span class="string">&quot;: 4,&quot;</span>parent<span class="string">&quot;:&quot;</span>paris<span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; &quot;</span>name<span class="string">&quot;: &quot;</span>Adrien Grand<span class="string">&quot;,&quot;</span>dob<span class="string">&quot;: &quot;</span><span class="number">1987</span><span class="number">-05</span><span class="number">-11</span><span class="string">&quot;,&quot;</span>hobby<span class="string">&quot;: &quot;</span>horses<span class="string">&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<p>通过子文档查询父文档要使用 has_child 查询。例如，搜索 1980 年以后出生的员工所在的分支机构，employee 中 1980 年以后出生的有 Mark Thomas 和 Adrien Grand，他们分别在 london 和 paris，执行以下查询命令进行验证：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">GET company<span class="regexp">/branch/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;has_child&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">			<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;range&quot;</span>: &#123; <span class="string">&quot;dob&quot;</span>: &#123; <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;1980-01-01&quot;</span> &#125; &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索哪些机构中有名为 “Alice Smith” 的员工，因为使用 match 查询，会解析为 “Alice” 和 “Smith”，所以 Alice Smith 和 Barry Smith 所在的机构会被匹配，执行以下查询命令进行验证：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">GET company<span class="regexp">/branch/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;has_child&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">			<span class="string">&quot;score_mode&quot;</span>: <span class="string">&quot;max&quot;</span>,</span><br><span class="line">			<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Alice Smith&quot;</span> &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用 min_children 指定子文档的最小个数。例如，搜索最少含有两个 employee 的机构，查询命令如下：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">GET company<span class="regexp">/branch/</span>_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;has_child&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;type&quot;</span>: <span class="string">&quot;employee&quot;</span>,</span><br><span class="line">			<span class="string">&quot;min_children&quot;</span>: <span class="number">2</span>,</span><br><span class="line">			<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="43-has_parent-query"><a class="markdownIt-Anchor" href="#43-has_parent-query"></a> 4.3. has_parent query</h3>
<p>通过父文档查询子文档使用 has_parent 查询。比如，搜索哪些 employee 工作在 UK，查询命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> company/employee/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;has_parent&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;parent_type&quot;</span>: <span class="string">&quot;branch&quot;</span>,</span><br><span class="line">			<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;country&quot;</span>: <span class="string">&quot;UK &#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="5-位置查询"><a class="markdownIt-Anchor" href="#5-位置查询"></a> 5. 位置查询</h2>
<p>Elasticsearch 可以对地理位置点 geo_point 类型和地理位置形状 geo_shape 类型的数据进行搜索。为了学习方便，这里准备一些城市的地理坐标作为测试数据，每一条文档都包含城市名称和地理坐标这两个字段，这里的坐标点取的是各个城市中心的一个位置。首先把下面的内容保存到 geo.json 文件中：</p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line">&#123;&quot;<span class="keyword">index</span><span class="string">&quot;:&#123; &quot;</span>_index<span class="string">&quot;:&quot;</span>geo<span class="string">&quot;,&quot;</span>_type<span class="string">&quot;:&quot;</span>city<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;:&quot;</span><span class="number">1</span><span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>北京<span class="string">&quot;,&quot;</span>location<span class="string">&quot;:&quot;</span><span class="number">39.9088145109</span>,<span class="number">116.3973999023</span><span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span><span class="keyword">index</span><span class="string">&quot;:&#123; &quot;</span>_index<span class="string">&quot;:&quot;</span>geo<span class="string">&quot;,&quot;</span>_type<span class="string">&quot;:&quot;</span>city<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;: &quot;</span><span class="number">2</span><span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>乌鲁木齐<span class="string">&quot;,&quot;</span>location<span class="string">&quot;:&quot;</span><span class="number">43.8266300000</span>,<span class="number">87.6168800000</span><span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span><span class="keyword">index</span><span class="string">&quot;:&#123; &quot;</span>_index<span class="string">&quot;:&quot;</span>geo<span class="string">&quot;,&quot;</span>_type<span class="string">&quot;:&quot;</span>city<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;:&quot;</span><span class="number">3</span><span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>西安<span class="string">&quot;,&quot;</span>location<span class="string">&quot;:&quot;</span><span class="number">34.3412700000</span>,<span class="number">108.9398400000</span><span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span><span class="keyword">index</span><span class="string">&quot;:&#123; &quot;</span>_index<span class="string">&quot;:&quot;</span>geo<span class="string">&quot;,&quot;</span>_type<span class="string">&quot;:&quot;</span>city<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;:&quot;</span><span class="number">4</span><span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>郑州<span class="string">&quot;,&quot;</span>location<span class="string">&quot;:&quot;</span><span class="number">34.7447157466</span>,<span class="number">113.6587142944</span><span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span><span class="keyword">index</span><span class="string">&quot;:&#123; &quot;</span>_index<span class="string">&quot;:&quot;</span>geo<span class="string">&quot;,&quot;</span>_type<span class="string">&quot;:&quot;</span>city<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;:&quot;</span><span class="number">5</span><span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>杭州<span class="string">&quot;,&quot;</span>location<span class="string">&quot;:&quot;</span><span class="number">30.2294080260</span>,<span class="number">120.1492309570</span><span class="string">&quot;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span><span class="keyword">index</span><span class="string">&quot;:&#123; &quot;</span>_index<span class="string">&quot;:&quot;</span>geo<span class="string">&quot;,&quot;</span>_type<span class="string">&quot;:&quot;</span>city<span class="string">&quot;,&quot;</span>_id<span class="string">&quot;:&quot;</span><span class="number">6</span><span class="string">&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;</span>name<span class="string">&quot;:&quot;</span>济南<span class="string">&quot;,&quot;</span>location<span class="string">&quot;:&quot;</span><span class="number">36.6518400000</span>,<span class="number">117.1200900000</span><span class="string">&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<p>创建一个索引并设置映射：</p>
<figure class="highlight fsharp"><table><tr><td class="code"><pre><span class="line">PUT <span class="keyword">geo</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">		<span class="string">&quot;city&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">			<span class="string">&quot;properties&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">				<span class="string">&quot;name&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">					<span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">&quot;location&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">					<span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行批量导入命令：</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line">curl -XPOST <span class="string">&quot;http://localhost:9200/_bulk?pretty&quot;</span> --data-<span class="built_in">binary</span> <span class="symbol">@geo</span>.json</span><br></pre></td></tr></table></figure>
<h3 id="51-geo_distance-query"><a class="markdownIt-Anchor" href="#51-geo_distance-query"></a> 5.1. geo_distance query</h3>
<p>geo_distance query 可以查找在一个中心点指定范围内的地理点文档。例如，查找距离天津 200km 以内的城市，搜索结果中会返回北京，命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> geo/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;geo_distance&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;distance&quot;</span>: <span class="string">&quot;200km&quot;</span>,</span><br><span class="line">					<span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;lat&quot;</span>: 39.0851000000,</span><br><span class="line">						<span class="string">&quot;lon&quot;</span>: 117.1993700000</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按各城市离北京的距离排序：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> geo/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [&#123;</span><br><span class="line">    <span class="string">&quot;_geo_distance&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: <span class="string">&quot;39.9088145109,116.3973999023&quot;</span>,</span><br><span class="line">      <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;km&quot;</span>,</span><br><span class="line">      <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span>,</span><br><span class="line">      <span class="string">&quot;distance_type&quot;</span>: <span class="string">&quot;plane&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 location 对应的经纬度字段；unit 为 <code>km</code> 表示将距离以 <code>km</code> 为单位写入到每个返回结果的 sort 键中；distance_type 为 <code>plane</code> 表示使用快速但精度略差的 <code>plane</code> 计算方式。</p>
<h3 id="52-geo_bounding_box-query"><a class="markdownIt-Anchor" href="#52-geo_bounding_box-query"></a> 5.2. geo_bounding_box query</h3>
<p>geo_bounding_box query 用于查找落入指定的矩形内的地理坐标。查询中由两个点确定一个矩形，然后在矩形区域内查询匹配的文档。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> geo/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;geo_bounding_box&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;top_left&quot;</span>: &#123;</span><br><span class="line">							<span class="string">&quot;lat&quot;</span>: 38.4864400000,</span><br><span class="line">							<span class="string">&quot;lon&quot;</span>: 106.2324800000</span><br><span class="line">						&#125;,</span><br><span class="line">						<span class="string">&quot;bottom_right&quot;</span>: &#123;</span><br><span class="line">							<span class="string">&quot;lat&quot;</span>: 28.6820200000,</span><br><span class="line">							<span class="string">&quot;lon&quot;</span>: 115.8579400000</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="53-geo_polygon-query"><a class="markdownIt-Anchor" href="#53-geo_polygon-query"></a> 5.3. geo_polygon query</h3>
<p>geo_polygon query 用于查找在指定<strong>多边形</strong>内的地理点。例如，呼和浩特、重庆、上海三地组成一个三角形，查询位置在该三角形区域内的城市，命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> geo/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;geo_polygon&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;points&quot;</span>: [&#123;</span><br><span class="line">						<span class="string">&quot;lat&quot;</span>: 40.8414900000,</span><br><span class="line">						<span class="string">&quot;lon&quot;</span>: 111.7519900000</span><br><span class="line">					&#125;, &#123;</span><br><span class="line">						<span class="string">&quot;lat&quot;</span>: 29.5647100000,</span><br><span class="line">						<span class="string">&quot;lon&quot;</span>: 106.5507300000</span><br><span class="line">					&#125;, &#123;</span><br><span class="line">						<span class="string">&quot;lat&quot;</span>: 31.2303700000,</span><br><span class="line">						<span class="string">&quot;lon&quot;</span>: 121.4737000000</span><br><span class="line">					&#125;]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="54-geo_shape-query"><a class="markdownIt-Anchor" href="#54-geo_shape-query"></a> 5.4. geo_shape query</h3>
<p>geo_shape query 用于查询 geo_shape 类型的地理数据，地理形状之间的关系有相交、包含、不相交三种。创建一个新的索引用于测试，其中 location 字段的类型设为 geo_shape 类型。</p>
<figure class="highlight fsharp"><table><tr><td class="code"><pre><span class="line">PUT <span class="keyword">geoshape</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">		<span class="string">&quot;city&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">			<span class="string">&quot;properties&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">				<span class="string">&quot;name&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">					<span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">&quot;location&quot;</span><span class="operator">:</span> &#123;</span><br><span class="line">					<span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;geo_shape&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于经纬度的顺序这里做一个说明，geo_point 类型的字段纬度在前经度在后，但是对于 geo_shape 类型中的点，是经度在前纬度在后，这一点需要特别注意。</p>
<p>把西安和郑州连成的线写入索引：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line"><span class="symbol">POST</span> geoshape/city/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;name&quot;</span>: <span class="string">&quot;西安-郑州&quot;</span>,</span><br><span class="line">	<span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;type&quot;</span>: <span class="string">&quot;linestring&quot;</span>,</span><br><span class="line">		<span class="string">&quot;coordinates&quot;</span>: [</span><br><span class="line">			[<span class="number">108.9398400000</span>, <span class="number">34.3412700000</span>],</span><br><span class="line">			[<span class="number">113.6587142944</span>, <span class="number">34.7447157466</span>]</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询包含在由银川和南昌作为对角线上的点组成的矩形的地理形状，由于西安和郑州组成的直线落在该矩形区域内，因此可以被查询到。命令如下：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line"><span class="symbol">GET</span> geoshape/<span class="symbol">_search</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;geo_shape&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">						<span class="string">&quot;shape&quot;</span>: &#123;</span><br><span class="line">							<span class="string">&quot;type&quot;</span>: <span class="string">&quot;envelope&quot;</span>,</span><br><span class="line">							<span class="string">&quot;coordinates&quot;</span>: [</span><br><span class="line">								[<span class="number">106.23248</span>, <span class="number">38.48644</span>],</span><br><span class="line">								[<span class="number">115.85794</span>, <span class="number">28.68202</span>]</span><br><span class="line">							]</span><br><span class="line">						&#125;,</span><br><span class="line">						<span class="string">&quot;relation&quot;</span>: <span class="string">&quot;within&quot;</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-特殊查询"><a class="markdownIt-Anchor" href="#6-特殊查询"></a> 6. 特殊查询</h2>
<h3 id="61-more_like_this-query"><a class="markdownIt-Anchor" href="#61-more_like_this-query"></a> 6.1. more_like_this query</h3>
<p>more_like_this query 可以查询和提供文本类似的文档，通常用于近似文本的推荐等场景。查询命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;more_like_ this&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;title&quot;</span>, <span class="string">&quot;description&quot;</span>],</span><br><span class="line">			<span class="string">&quot;like&quot;</span>: <span class="string">&quot;java virtual machine&quot;</span>,</span><br><span class="line">			<span class="string">&quot;min_term_freq&quot;</span>: 1,</span><br><span class="line">			<span class="string">&quot;max_query_terms&quot;</span>: 12</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可选的参数及取值说明如下：</p>
<ul>
<li>fields 要匹配的字段，默认是 _all 字段。</li>
<li>like 要匹配的文本。</li>
<li>min_term_freq 文档中词项的最低频率，默认是 2，低于此频率的文档会被忽略。</li>
<li>max_query_terms query 中能包含的最大词项数目，默认为 25。</li>
<li>min_doc_freq 最小的文档频率，默认为 5。</li>
<li>max_doc_freq 最大文档频率。</li>
<li>min_word length 单词的最小长度。</li>
<li>max_word length 单词的最大长度。</li>
<li>stop_words 停用词列表。</li>
<li>analyzer 分词器。</li>
<li>minimum_should_match 文档应匹配的最小词项数，默认为 query 分词后词项数的 30%。</li>
<li>boost terms 词项的权重。</li>
<li>include 是否把输入文档作为结果返回。</li>
<li>boost 整个 query 的权重，默认为 1.0。</li>
</ul>
<h3 id="62-script-query"><a class="markdownIt-Anchor" href="#62-script-query"></a> 6.2. script query</h3>
<p>Elasticsearch 支持使用脚本进行查询。例如，查询价格大于 180 的文档，命令如下：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">GET</span> books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;inline&quot;</span>: <span class="string">&quot;doc[&#x27;price&#x27;].value &gt; 180&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;painless&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="63-percolate-query"><a class="markdownIt-Anchor" href="#63-percolate-query"></a> 6.3. percolate query</h3>
<p>一般情况下，我们是先把文档写入到 Elasticsearch 中，通过查询语句对文档进行搜索。percolate query 则是反其道而行之的做法，它会先注册查询条件，根据文档来查询 query。例如，在 my-index 索引中有一个 laptop 类型，文档有 price 和 name 两个字段，在映射中声明一个 percolator 类型的 query，命令如下：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">PUT <span class="keyword">my</span>-<span class="keyword">index</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;laptop&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;price&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span> &#125;,</span><br><span class="line">				<span class="string">&quot;name&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;queries&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">					<span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;percolator&quot;</span> &#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册一个 bool query，bool query 中包含一个 range query，要求 price 字段的取值小于等于 10000，并且 name 字段中含有关键词 macbook：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">PUT <span class="regexp">/my-index/</span>queries/<span class="number">1</span>?refresh</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;must&quot;</span>: [&#123;</span><br><span class="line">				<span class="string">&quot;range&quot;</span>: &#123; <span class="string">&quot;price&quot;</span>: &#123; <span class="string">&quot;lte&quot;</span>: <span class="number">10000</span> &#125; &#125;</span><br><span class="line">			&#125;, &#123;</span><br><span class="line">				<span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;macbook&quot;</span> &#125;</span><br><span class="line">			&#125;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过文档查询 query：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">GET <span class="regexp">/my-index/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;percolate&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;field&quot;</span>: <span class="string">&quot;query&quot;</span>,</span><br><span class="line">			<span class="string">&quot;document_type&quot;</span>: <span class="string">&quot;laptop&quot;</span>,</span><br><span class="line">			<span class="string">&quot;document&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;price&quot;</span>: <span class="number">9999</span>,</span><br><span class="line">				<span class="string">&quot;name&quot;</span>: <span class="string">&quot;macbook pro on sale&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文档符合 query 中的条件，返回结果中可以查到上文中注册的 bool query。percolate query 的这种特性适用于数据分类、数据路由、事件监控和预警等场景。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/cdfec3bd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/cdfec3bd.html" class="post-title-link" itemprop="url">如何设计系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/cdfec3bd.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="cdfec3bd.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="如何设计系统"><a class="markdownIt-Anchor" href="#如何设计系统"></a> 如何设计系统</h1>
<h2 id="1-系统设计过程"><a class="markdownIt-Anchor" href="#1-系统设计过程"></a> 1. 系统设计过程</h2>
<h3 id="11-步骤一-约束和用例"><a class="markdownIt-Anchor" href="#11-步骤一-约束和用例"></a> 1.1. 步骤一、约束和用例</h3>
<p>对于任何系统设计，第一件应该做的事是：阐明系统的约束并确定系统需要满足哪些用例。</p>
<p>永远不要假设没有明确说明的事情。一定要尽力收集、理解需求，并设计一个很好地涵盖这些要求的解决方案。</p>
<p>例如，URL 缩短服务可能只为几千个用户提供服务，但每个用户都可能共享数百万个 URL。它可能旨在处理对缩短的 URL 的数百万次点击或数十次点击。该服务可能必须提供有关每个缩短的 URL 的大量统计信息（这会增加您的数据大小），或者可能根本不需要统计信息。</p>
<p>您还必须考虑预期会发生的用例。您的系统将根据其预期功能进行设计。不要忘记确保你知道面试官一开始没有告诉你的所有要求。</p>
<h3 id="12-步骤二-顶层设计"><a class="markdownIt-Anchor" href="#12-步骤二-顶层设计"></a> 1.2. 步骤二、顶层设计</h3>
<p>一旦确定了要设计的系统的范围，接下来就要做顶层设计：概述系统架构中所需的所有重要组件。</p>
<p>此时，应该绘制出主要组件以及它们之间的连接。通常，这种顶层设计是基于主流技术的组合。这就要求设计必须熟悉这些技术，了解其利弊以及适合使用的场景。</p>
<h3 id="13-步骤三-分析瓶颈"><a class="markdownIt-Anchor" href="#13-步骤三-分析瓶颈"></a> 1.3. 步骤三、分析瓶颈</h3>
<p>顶层设计很可能会遇到一个或多个瓶颈。这完全没问题，不要指望一个新系统可以立即处理世界上的所有负载。它只需要可扩展，以便您能够使用一些标准工具和技术对其进行改进。</p>
<p>现在有了顶层设计，就要考虑这些组件在系统扩展时面临的瓶颈。也许，系统需要一个负载均衡器和集群来处理用户请求。或者，由于数据容量庞大，以至于需要将数据库分库分表（分布在多台机器上）。这些方案有什么利弊，是否适用？数据库是否太慢，是否需要一些内存缓存？</p>
<p>通常每个解决方案都是某种权衡和取舍。改变某事会使其他事情恶化。然而，重要的是能够讨论这些权衡，并根据定义的约束和用例来衡量它们对系统的影响。</p>
<p>一旦分析清楚核心瓶颈，就可以着手在下一步中去解决它们。</p>
<h3 id="14-步骤四-扩展设计"><a class="markdownIt-Anchor" href="#14-步骤四-扩展设计"></a> 1.4. 步骤四、扩展设计</h3>
<p>首先，你需要了解以下技术手段：</p>
<ul>
<li>垂直扩展</li>
<li>水平罗占</li>
<li>缓存</li>
<li>负载均衡</li>
<li>数据库复制</li>
<li>数据库分区</li>
<li>异步</li>
<li>NoSql</li>
</ul>
<p>在系统设计方面，回顾现实中的架构非常有用。注意使用了哪些技术。继续研究每一项新技术，看看它解决了什么问题，它的替代品是什么，它擅长的地方，以及失败的地方。</p>
<p>一切都是权衡的结果——这是系统设计中最基本的概念之一。</p>
<p>一些推荐的学习资料</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2017/10/23/one-model-at-a-time-integrating-and-running-deep-learning-mo.html">生产中的深度学习</a>：关于 EyeEm 如何构建在大量图像上运行多个深度学习模型的生产系统的精彩故事</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2016/10/12/lessons-learned-from-scaling-uber-to-2000-engineers-1000-ser.html">Uber</a>：一篇关于 Uber 如何快速扩展的好文章，关于将您的服务分解为分布在许多存储库中的许多微服务。</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2016/6/27/how-facebook-live-streams-to-800000-simultaneous-viewers.html">Facebook</a>：Facebook 如何在直播中同时处理 800,000 名观众</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2016/6/15/the-image-optimization-technology-that-serves-millions-of-re.html">Kraken.io</a>：如何大规模缩放图像优化，本文将更详细地看一些具体使用的硬件方案，以及部署、监控等重要方面</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2016/4/20/how-twitter-handles-3000-images-per-second.html">Twitter</a>：Twitter 如何处理每秒 3,000 张图片上传以及为什么它使用的旧方式现在行不通</li>
<li>最后，Twitter 子组件的一些很好的例子：存储数据（<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=5cKTP36HVgI">video</a> | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/12/19/how-twitter-stores-250-million-tweets-a-day-using-mysql.html">text</a>）和时间轴（<a target="_blank" rel="noopener" href="http://www.infoq.com/presentations/Twitter-Timeline-Scalability">video</a> | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/7/8/the-architecture-twitter-uses-to-deal-with-150m-active-users.html">text</a>）。</li>
<li>有关更高级的示例，请查看 Google、Youtube（<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w5WVu624fY8">video</a> | <a target="_blank" rel="noopener" href="http://highscalability.com/youtube-architecture">text</a>）、<a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/2/13/tumblr-architecture-15-billion-page-views-a-month-and-harder.html">Tumblr</a>、<a target="_blank" rel="noopener" href="http://highscalability.com/blog/2009/8/5/stack-overflow-architecture.html">StackOverflow</a> 和 <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/11/29/datasift-architecture-realtime-datamining-at-120000-tweets-p.html">Datashift</a> 上的这些帖子。</li>
</ul>
<h2 id="2-参考资料"><a class="markdownIt-Anchor" href="#2-参考资料"></a> 2. 参考资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer">system-design-primer</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hiredintech.com/courses/system-design">System Design for Tech Interviews</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/41166861.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/41166861.html" class="post-title-link" itemprop="url">分布式理论</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA/" itemprop="url" rel="index"><span itemprop="name">分布式理论</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/41166861.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="41166861.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分布式理论"><a class="markdownIt-Anchor" href="#分布式理论"></a> 分布式理论</h1>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20200202201007.png" alt="img" /></p>
<h2 id="1-分布式特性和分类"><a class="markdownIt-Anchor" href="#1-分布式特性和分类"></a> 1. 分布式特性和分类</h2>
<h3 id="11-分布式特性"><a class="markdownIt-Anchor" href="#11-分布式特性"></a> 1.1. 分布式特性</h3>
<ul>
<li><strong>性能</strong>：用于衡量一个系统处理各种任务的能力。
<ul>
<li><strong>吞吐量</strong>：系统在一定时间内可以处理的任务数。
<ul>
<li><strong>QPS</strong>，即每秒查询数</li>
<li><strong>TPS</strong>，即每秒事务数</li>
</ul>
</li>
<li><strong>响应时间</strong>：系统响应一个请求或输入需要花费的时间。</li>
</ul>
</li>
<li><strong>可用性</strong>：指的是系统在面对各种异常时可以正确提供服务的能力。系统的可用性可以用系统停止服务的时间与总的时间之比衡量。</li>
<li><strong>可扩展性</strong>：指的是分布式系统通过扩展集群机器规模提高系统性能 (吞吐、响应时间、 完成时间)、存储容量、计算能力的特性，是分布式系统的特有性质。</li>
</ul>
<h3 id="12-分布式分类"><a class="markdownIt-Anchor" href="#12-分布式分类"></a> 1.2. 分布式分类</h3>
<ul>
<li><strong>分布式计算</strong>：解决应用的分布式计算问题。基于分布式计算模式，包括批处理计算、离线计算、在线计算、融合计算等，根据应用类型构建高效智能的分布式计算框架。</li>
<li><strong>分布式存储</strong>：解决数据的分布式和多元化问题。包括分布式数据库、分布式文件系统、分布式缓存等，支持不同类型的数据的存储和管理。</li>
<li><strong>分布式通信</strong>：解决进程间的分布式通信问题。通过消息队列、远程调用等方式，实现简单高效的通信。</li>
<li><strong>分布式资源管理</strong>：解决资源的分布式和异构性问题。将 CPU、内存、IO 等物理资源虚拟化，新城逻辑资源池，以便统一管理。</li>
</ul>
<h2 id="2-cap-定理"><a class="markdownIt-Anchor" href="#2-cap-定理"></a> 2. CAP 定理</h2>
<blockquote>
<p>CAP 定理是加州大学计算机科学家埃里克·布鲁尔提出来的猜想，后来被证明成为分布式计算领域公认的定理。</p>
</blockquote>
<p><strong>CAP 定理</strong>，指的是：<strong>在一个分布式系统中， 最多只能同时满足其中两项</strong>。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20211102191636.png" style="width: 400px" />
<p>CAP 就是取 Consistency、Availability、Partition Tolerance 的首字母而命名。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20211102180526.png" alt="img" /></p>
<ul>
<li>一致性（<strong>C</strong>onsistency）：在任何给定时间，网络中的所有节点都具有完全相同（最近）的值。</li>
<li>可用性（<strong>A</strong>vailability）：对网络的每个请求都会收到响应，但不能保证返回的数据是最新的。</li>
<li>分区容错性（<strong>P</strong>artition Tolerance）：即使任意数量的节点出现故障，网络仍会继续运行。</li>
</ul>
<h3 id="21-一致性"><a class="markdownIt-Anchor" href="#21-一致性"></a> 2.1. 一致性</h3>
<p>一致性（Consistency）指的是<strong>多个数据副本是否能保持一致</strong>的特性。</p>
<p>在一致性的条件下，分布式系统在执行写操作成功后，如果所有用户都能够读取到最新的值，该系统就被认为具有强一致性。</p>
<p>数据一致性又可以分为以下几点：</p>
<ul>
<li><strong>强一致性</strong> - 数据更新操作结果和操作响应总是一致的，即操作响应通知更新失败，那么数据一定没有被更新，而不是处于不确定状态。</li>
<li><strong>最终一致性</strong> - 即物理存储的数据可能是不一致的，终端用户访问到的数据可能也是不一致的，但系统经过一段时间的自我修复和修正，数据最终会达到一致。</li>
</ul>
<p>举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071602.png" alt="img" /></p>
<p>接下来，用户的读操作就会得到 v1。这就叫一致性。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071603.png" alt="img" /></p>
<p>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071604.png" alt="img" /></p>
<p>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071605.png" alt="img" /></p>
<p>这样的话，用户向 G2 发起读操作，也能得到 v1。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071606.png" alt="img" /></p>
<h3 id="22-可用性"><a class="markdownIt-Anchor" href="#22-可用性"></a> 2.2. 可用性</h3>
<p>可用性指<strong>分布式系统在面对各种异常时可以提供正常服务的能力</strong>，可以用系统可用时间占总时间的比值来衡量，4 个 9 的可用性表示系统 <code>99.99%</code> 的时间是可用的。</p>
<p>在可用性条件下，系统提供的服务一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。</p>
<h3 id="23-分区容错性"><a class="markdownIt-Anchor" href="#23-分区容错性"></a> 2.3. 分区容错性</h3>
<p>分区容错性（Partition Tolerance）指 <strong>分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障</strong>。</p>
<p>在一个分布式系统里面，节点组成的网络本来应该是连通的。然而可能因为一些故障，使得有些节点之间不连通了，整个网络就分成了几块区域。数据就散布在了这些不连通的区域中，这就叫分区。</p>
<p>假设，某个数据项只在一个节点中保存，那么分区出现后，和这个节点不连通的部分就访问不到这个数据了。这时分区就是无法容忍的。</p>
<p>提高分区容错性的办法就是一个数据项复制到多个节点上，那么出现分区之后，这一数据项就可能分布到各个区里。容错性就提高了。</p>
<p>然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作就都要等待全部节点写成功，而这等待又会带来可用性的问题。</p>
<p>总的来说就是，数据存在的节点越多，分区容错性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。</p>
<p>大多数分布式系统都分布在多个子网络，每个子网络就叫做一个区（Partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</p>
<p><img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071601.png" alt="img" /></p>
<p>上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p>
<p><strong>一般来说，分区容错无法避免</strong>，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。</p>
<h3 id="24-ap-or-cp"><a class="markdownIt-Anchor" href="#24-ap-or-cp"></a> 2.4. AP or CP</h3>
<p>在分布式系统中，分区容错性必不可少，因为需要总是假设网络是不可靠的。因此，<strong>CAP 理论实际在是要在可用性和一致性之间做权衡</strong>。</p>
<p>由于分布式数据存储（如区块链）的性质，分区容错性是一个既定的事实；网络中总会有失败/无法访问的节点（尤其是因为互联网的不稳定特性）。 CAP 定理指出，当存在 P（分区）时，必须在 C（一致性）或 A（可用性）之间进行选择。</p>
<p>（1）AP 模式</p>
<blockquote>
<p><strong>AP</strong> <strong>模式</strong>：对网络的每个请求都会收到响应，即使网络由于网络分区故障而无法保证它是最新的。</p>
</blockquote>
<p>选择 <strong>AP</strong> <strong>模式</strong>，实现了服务的高可用。用户访问系统的时候，都能得到响应数据，不会出现响应错误；但是，当出现分区故障时，相同的读操作，访问不同的节点，得到响应数据可能不一样。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20211102191819.png" style="width: 500px" />
<p>（2）CP 模式</p>
<blockquote>
<p><strong>CP</strong> <strong>模式</strong>：如果由于网络分区（故障节点）而无法保证特定信息是最新的，则系统将返回错误或超时。</p>
</blockquote>
<p>选择 <strong>CP</strong> <strong>模式</strong>，这样能够提供一部分的可用性。采用 CP 模型的分布式系统，一旦因为消息丢失、延迟过高发生了网络分区，就影响用户的体验和业务的可用性。因为为了防止数据不一致，集群将拒绝新数据的写入。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20211102191820.png" style="width: 500px" />
<h2 id="3-base-定理"><a class="markdownIt-Anchor" href="#3-base-定理"></a> 3. BASE 定理</h2>
<h3 id="31-什么是-base-定理"><a class="markdownIt-Anchor" href="#31-什么是-base-定理"></a> 3.1. 什么是 BASE 定理</h3>
<blockquote>
<p><strong>BASE 定理是对 CAP 中一致性和可用性权衡的结果</strong>。</p>
</blockquote>
<p>BASE 是 <strong><code>基本可用（Basically Available）</code></strong>、<strong><code>软状态（Soft State）</code></strong> 和 <strong><code>最终一致性（Eventually Consistent）</code></strong> 三个短语的缩写。</p>
<p>BASE 理论的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。</p>
<ul>
<li>**基本可用（Basically Available）**分布式系统在出现故障的时候，<strong>保证核心可用，允许损失部分可用性</strong>。例如，电商在做促销时，为了保证购物系统的稳定性，部分消费者可能会被引导到一个降级的页面。</li>
<li><strong>软状态（Soft State）<strong>指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性，即</strong>允许系统不同节点的数据副本之间进行同步的过程存在延时</strong>。</li>
<li><strong>最终一致性（Eventually Consistent）<strong>强调的是</strong>系统中所有的数据副本，在经过一段时间的同步后，最终能达到一致的状态</strong>。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/cs/design/architecture/%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA-BASE.png" alt="img" /></p>
<h3 id="32-base-vs-acid"><a class="markdownIt-Anchor" href="#32-base-vs-acid"></a> 3.2. BASE vs. ACID</h3>
<p>BASE 的理论的<strong>核心思想</strong>是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。</p>
<p>ACID 要求强一致性，通常运用在传统的数据库系统上。而 BASE 要求最终一致性，通过<strong>牺牲强一致性来达到可用性</strong>，通常运用在大型分布式系统中。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20211102192406.png" style="width: 640px" />
<p>在实际的分布式场景中，不同业务单元和组件对一致性的要求是不同的，因此 ACID 和 BASE 往往会结合在一起使用。</p>
<h2 id="4-错误的分布式假设"><a class="markdownIt-Anchor" href="#4-错误的分布式假设"></a> 4. 错误的分布式假设</h2>
<blockquote>
<p>内容摘自 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing">Fallacies of Distributed Computing</a></p>
</blockquote>
<p>随着时间的推移，每一条都会被证明是错误的，也都会导致严重的问题，以及痛苦的学习体验：</p>
<ul>
<li>网络是稳定的</li>
<li>网络传输的延迟是零</li>
<li>网络的带宽是无穷大</li>
<li>网络是安全的</li>
<li>网络的拓扑不会改变</li>
<li>只有一个系统管理员</li>
<li>传输数据的成本为零</li>
<li>整个网络是同构的</li>
</ul>
<p>为什么我们要深刻地认识这 8 个错误？</p>
<p>是因为，这要我们清楚地认识到——<strong>在分布式系统中，错误是不可能避免的</strong>。既然错误无可避免，那么，我们应该做的是，将容错也作为功能去实现。</p>
<h2 id="5-拜占庭将军问题"><a class="markdownIt-Anchor" href="#5-拜占庭将军问题"></a> 5. 拜占庭将军问题</h2>
<blockquote>
<p>拜占庭将军问题是由<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%8E%B1%E6%96%AF%E5%88%A9%C2%B7%E5%85%B0%E6%B3%A2%E7%89%B9">莱斯利·兰波特</a>在其同名论文中提出的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AF%B9%E7%AD%89%E7%BD%91%E7%BB%9C">分布式对等网络</a>通信容错问题。</p>
<p>在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%B8%83%E5%BC%8F%E8%A8%88%E7%AE%97">分布式计算</a>中，不同的节点通过通讯交换信息达成共识而按照同一套协作策略行动。但有时候，系统中的节点可能出错而发送错误的信息，用于传递信息的通讯网络也可能导致信息损坏，使得网络中不同的成员关于全体协作的策略得出不同结论，从而破坏系统一致性。拜占庭将军问题被认为是容错性问题中最难的问题类型之一。</p>
</blockquote>
<h3 id="51-问题描述"><a class="markdownIt-Anchor" href="#51-问题描述"></a> 5.1. 问题描述</h3>
<p>一群拜占庭将军各领一支军队共同围困一座城市。</p>
<p>为了简化问题，军队的行动策略只有两种：<strong>进攻</strong>（Attack，后面简称 A）或 <strong>撤退</strong>（Retreat，后面简称 R）。如果这些军队不是统一进攻或撤退，就可能因兵力不足导致失败。因此，<strong>将军们通过投票来达成一致策略：同进或同退</strong>。</p>
<p>因为将军们分别在城市的不同方位，所以他们只能<strong>通过信使互相联系</strong>。在投票过程中，<strong>每位将军都将自己的投票信息（A 或 R）通知其他所有将军</strong>，这样一来每位将军根据自己的投票和其他所有将军送来的信息就可以分析出共同的投票结果而决定行动策略。</p>
<p>这个抽象模型的问题在于：<strong>将军中可能存在叛徒，他们不仅会发出误导性投票，还可能选择性地发送投票信息</strong>。</p>
<p>由于将军之间需要通过信使通讯，叛变将军可能通过伪造信件来以其他将军的身份发送假投票。而即使在保证所有将军忠诚的情况下，也不能排除信使被敌人截杀，甚至被敌人间谍替换等情况。因此很难通过保证人员可靠性及通讯可靠性来解决问题。</p>
<p>假使那些忠诚（或是没有出错）的将军仍然能通过多数决定来决定他们的战略，便称达到了拜占庭容错。在此，票都会有一个默认值，若消息（票）没有被收到，则使用此默认值来投票。</p>
<p>上述的故事可以映射到分布式系统中，<em>将军代表分布式系统中的节点；信使代表通信系统；叛徒代表故障或异常</em>。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210704104211.png" alt="img" /></p>
<h3 id="52-问题分析"><a class="markdownIt-Anchor" href="#52-问题分析"></a> 5.2. 问题分析</h3>
<blockquote>
<p>兰伯特针对拜占庭将军问题，给出了两个解决方案：口头协议和书面协议。</p>
<p>本文介绍一下口头协议。</p>
</blockquote>
<p>在口头协议中，拜占庭将军问题被简化为<strong>将军 - 副官</strong>模型，其核心规则如下：</p>
<ul>
<li>忠诚的副官遵守同一命令。</li>
<li>若将军是忠诚的，所有忠诚的副官都执行他的命令。</li>
<li><strong>如果叛徒人数为 m，将军人数不能少于 3m + 1</strong> ，那么拜占庭将军问题就能解决了。</li>
</ul>
<p><strong>示例一、叛徒人数为 1，将军人数为 3</strong></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210704112012.png" alt="img" /></p>
<p>这个示例中，将军人数不满足 3m + 1，无法保证忠诚的副官都执行将军的命令。</p>
<p><strong>示例二、叛徒人数为 1，将军人数为 4</strong></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20210704194815.png" alt="img" /></p>
<p>这个示例中，将军人数满足 3m + 1，无论是副官中有叛徒，还是将军是叛徒，都能保证忠诚的副官执行将军的命令。</p>
<h2 id="6-参考资料"><a class="markdownIt-Anchor" href="#6-参考资料"></a> 6. 参考资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98">Wiki - 拜占庭将军问题</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av78588312/">拜占庭将军问题视频讲解</a> - 李永乐老师讲解的通俗易懂</li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing">Fallacies of Distributed Computing</a> - 分布式系统新手常犯的 8 个错误，并探讨了其会带来的影响。</li>
<li><a target="_blank" rel="noopener" href="http://book.mixu.net/distsys/">Distributed Systems for Fun and Profit</a> - 一本学习小册，涵盖了分布式系统中的关键问题，包括时间的作用和不同的复制策略。</li>
<li><a target="_blank" rel="noopener" href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.41.7628&amp;rep=rep1&amp;type=pdf">A Note on Distributed Systems</a> - 这是一篇经典的论文，讲述了为什么在分布式系统中，远程交互不能像本地对象那样进行。</li>
<li><a target="_blank" rel="noopener" href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Amazon’s Highly Available Key-value Store</a></li>
<li><a target="_blank" rel="noopener" href="https://cryptographics.info/cryptographics/blockchain/cap-theorem/">CAP Theorem</a></li>
<li><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/CAP-twelve-years-later%3A-How-the-%22rules%22-have-Brewer/c9c73f5a1668b8bf12aae2efb6ac5a5a2c34002a">CAP twelve years later: How the “rules” have changed</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/07/cap.html">CAP 定理的含义</a> - by 阮一峰</li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5d720e86f265da03cc08de74">神一样的 CAP 理论被应用在何方</a></li>
<li><a target="_blank" rel="noopener" href="https://queue.acm.org/detail.cfm?id=1394128">BASE: An Acid Alternative</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/57ce02bb.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/57ce02bb.html" class="post-title-link" itemprop="url">Cinchcast 的架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" itemprop="url" rel="index"><span itemprop="name">解决方案</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/57ce02bb.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="57ce02bb.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="cinchcast-的架构"><a class="markdownIt-Anchor" href="#cinchcast-的架构"></a> Cinchcast 的架构</h1>
<p>Cinchcast 提供的解决方案允许公司创建、共享、衡量和货币化音频内容，以接触和吸引对其业务最重要的人。我们的技术将会议桥接器与实时音频流相结合，以简化在线活动并增强参与者的参与度。 Cinchcast 技术还用于为全球最大的音频社交网络 Blogtalkradio 提供动力。今天，我们的平台每天制作和分发超过 1,500 小时的原创内容。在本文中，我们描述了我们为扩展平台以支持这种规模的数据而做出的工程决策。</p>
<h2 id="统计数据"><a class="markdownIt-Anchor" href="#统计数据"></a> 统计数据</h2>
<ul>
<li>浏览量每月超过 5000 万</li>
<li>创建了 50000 小时的音频内容</li>
<li>1500 万个流媒体</li>
<li>175,000,000 次广告展示</li>
<li>峰值每秒 40000 并发请求</li>
<li>MSSQL、Redis、ElasticSearch 集群中存储的数据达到每天数 TB，</li>
<li>10 人工程师团队</li>
<li>生产环境大概有 100 左右的硬件节点</li>
</ul>
<h2 id="数据中心"><a class="markdownIt-Anchor" href="#数据中心"></a> 数据中心</h2>
<p>线上网站部署在布鲁克林的数据中心。但 QA 和 Staging 环境则使用了 Amazon EC2 云实例。</p>
<p>——考虑到数据安全，大部分公司不愿意把真实数据部署在云端。</p>
<h2 id="硬件"><a class="markdownIt-Anchor" href="#硬件"></a> 硬件</h2>
<ul>
<li>大概有 50 台 Web 服务器</li>
<li>15 台 MS SQL 数据库服务器</li>
<li>2 台 Redis 的 NoSQL 的键值服务器</li>
<li>2 台 NodeJS 服务器</li>
<li>2 台 弹性搜索集群服务器</li>
</ul>
<h2 id="开发工具"><a class="markdownIt-Anchor" href="#开发工具"></a> 开发工具</h2>
<ul>
<li>NET 4 C#：<a target="_blank" rel="noopener" href="http://ASP.NET">ASP.NET</a> 和 MVC3</li>
<li>IDE 用的是 Visual Studio 2010 Team Suite</li>
<li>用 StyleCop、ReSharper 来强化代码标准</li>
<li>使用敏捷。其中大的功能用 Scrum，小任务则通过看板任务墙管理</li>
<li>测试和持续集成使用 Jenkins + Nunit</li>
<li>自动化测试则是 Selenium 和 Sauce On Demand</li>
</ul>
<h2 id="软件和使用的技术"><a class="markdownIt-Anchor" href="#软件和使用的技术"></a> 软件和使用的技术</h2>
<ul>
<li>Windows Server 2008 R2 的 64 位操作系统</li>
<li>基于微软 Windows Server 2008 Web 服务器下运行的 SQL Server 2005</li>
<li>负载均衡是 EQL(Equalizer load balancers)</li>
<li>Redis 作为分布式缓存层和消息分发队列</li>
<li>NodeJS 用来进行实时分析和更新仪表盘</li>
<li>搜索用得是 ElasticSearch，日志分析是通过 Sawmill+自定义分析器脚本</li>
</ul>
<h2 id="监测"><a class="markdownIt-Anchor" href="#监测"></a> 监测</h2>
<ul>
<li>NewRelic：性能监控</li>
<li>性能对 KPI（转换率，页面浏览量）的影响：Chartbeat：</li>
<li>Gomez，WhatsupGold，Nagios 等用来各种预警和报警</li>
<li>SQL Server monitoring 的监控：来自 Red Gate 的 SQL Monitor</li>
</ul>
<h2 id="我们的原则"><a class="markdownIt-Anchor" href="#我们的原则"></a> 我们的原则</h2>
<ul>
<li>尊重他人的时间。不要带着问题来，要拿出解决办法。</li>
<li>不要去追逐当下的热点技术，先实现基本功能，然后再做锦上添花的。务实是最重要的。</li>
<li>成为一个“如何做”的团队而不是总是说“不”的团队</li>
<li>预先处理总比亡羊补牢要好，把安全植入到软件开发生命周期中，通过培训开发人员如何写出安全的软件并把它从一开始就作为业务优先考虑之处。</li>
</ul>
<h2 id="架构"><a class="markdownIt-Anchor" href="#架构"></a> 架构</h2>
<ul>
<li>所有 Javascript、CSS 和图像都缓存在 CDN 级别。 DNS 指向一个 CDN，它将请求传递给源服务器。我们使用 Cotendo 是因为它允许在 CDN 上做出 L7 路由决策。</li>
<li>单独的 Web 服务器集群用于为普通用户和广告用户的请求提供服务，通过 cookie 进行区分。</li>
<li>我们正在转向面向服务的架构，其中系统的关键部分，例如搜索、身份验证、缓存，都是以各种语言实现的 RESTFUL 服务。这些服务还提供了一个缓存层。</li>
<li>REDIS NOSQL 键值存储（<a target="_blank" rel="noopener" href="http://redis.io">redis.io</a>）用作数据库调用之前的缓存层。</li>
<li>Scaleout 用于在网络服务器集群中维护会话状态。但是，我们正在考虑切换到 REDIS。</li>
</ul>
<h2 id="经验教训"><a class="markdownIt-Anchor" href="#经验教训"></a> 经验教训</h2>
<ul>
<li>SQL Server 数据库中的文本搜索不好用，经常出现 CPU 阻塞，所以 Cinchcast 切换到 ElasticSearch，一个 Lucene 的衍生工具。</li>
<li>微软内置的会话模块容易出现死锁，他们用 AngiesList 会话模块取代了它，并把数据存储到 Redis。</li>
<li>日志是发现问题的关键。</li>
<li>重新发明轮子，有时候也可以是一件好事。例如，在一个供应商的提供的 JS / CSS 的产品导致性能问题的时候，他们通过重写显著改善了网站的性能。</li>
<li>并不是所有的数据都是关系型的。</li>
<li>在开发中不使用指标检测就像在风暴中不参考高度表来降落飞机，因此整个开发过程中，一定要通过网站吞吐量，解决错误的时间、代码覆盖率，等指标来衡量你的效率。 总的来说，对于日 PV 百万级的网站来说，Cinchcast 的架构、研发、运维等层面的技术选型和经验值得学习和参考。</li>
</ul>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/7/16/cinchcast-architecture-producing-1500-hours-of-audio-every-d.html">每天产生 1500 小时的音频</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/77cd4175.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/77cd4175.html" class="post-title-link" itemprop="url">README</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" itemprop="url" rel="index"><span itemprop="name">解决方案</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/77cd4175.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="77cd4175.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>854</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h1>
<h2 id="内容"><a class="markdownIt-Anchor" href="#内容"></a> 📖 内容</h2>
<h3 id="知名系统架构"><a class="markdownIt-Anchor" href="#知名系统架构"></a> 知名系统架构</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>细分类型</th>
<th>系统</th>
<th>资料</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data processing</td>
<td></td>
<td><strong>MapReduce</strong> - Google 的分布式数据处理</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/zh-CN/us/archive/mapreduce-osdi04.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Data processing</td>
<td></td>
<td><strong>Spark</strong> - Databricks 的分布式数据处理</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/AGrishchenko/apache-spark-architecture">slideshare.net</a></td>
</tr>
<tr>
<td>Data processing</td>
<td></td>
<td><strong>Storm</strong> - Twitter 的分布式数据处理</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/previa/storm-16094009">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>Bigtable</strong> - Google 的列式数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">harvard.edu</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>HBase</strong> - Bigtable 的开源实现</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/alexbaranau/intro-to-hbase">slideshare.net</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>Cassandra</strong> - Facebook 的列式数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/planetcassandra/cassandra-introduction-features-30103666">slideshare.net</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>DynamoDB</strong> - Amazon 的文档数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/decandia07dynamo.pdf">harvard.edu</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>MongoDB</strong> - 文档数据库</td>
<td><a target="_blank" rel="noopener" href="https://dunwu.github.io/db-tutorial/nosql/mongodb/">MongoDB</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>Spanner</strong> - Google 的全球分布数据库</td>
<td><a target="_blank" rel="noopener" href="http://research.google.com/archive/spanner-osdi2012.pdf">research.google.com</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>Memcached</strong> - 分布式内存缓存系统</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/oemebamo/introduction-to-memcached">slideshare.net</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>Nosql</td>
<td><strong>Redis</strong> - 能够持久化及具有值类型的分布式内存缓存系统</td>
<td><a target="_blank" rel="noopener" href="https://dunwu.github.io/db-tutorial/nosql/redis/">Redis</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>文件系统</td>
<td><strong>Google File System (GFS)</strong> - 分布式文件系统</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/zh-CN/us/archive/gfs-sosp2003.pdf">research.google.com</a></td>
</tr>
<tr>
<td>分布式存储</td>
<td>文件系统</td>
<td><strong>Hadoop File System (HDFS)</strong> - GFS 的开源实现</td>
<td><a target="_blank" rel="noopener" href="https://hadoop.apache.org/docs/r1.2.1/hdfs_design.html">apache.org</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>分布式中间件</td>
<td></td>
<td><strong>Chubby</strong> - Google 的分布式系统的低耦合锁服务</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/external_content/untrusted_dlcp/research.google.com/en/us/archive/chubby-osdi06.pdf">research.google.com</a></td>
</tr>
<tr>
<td>分布式中间件</td>
<td></td>
<td><strong>Dapper</strong> - 分布式系统跟踪基础设施</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36356.pdf">research.google.com</a></td>
</tr>
<tr>
<td>分布式中间件</td>
<td>MQ</td>
<td><strong>Kafka</strong> - LinkedIn 的发布订阅消息系统</td>
<td><a target="_blank" rel="noopener" href="https://dunwu.github.io/bigdata-tutorial/kafka/">Kafka</a></td>
</tr>
<tr>
<td>分布式中间件</td>
<td>分布式协调</td>
<td><strong>Zookeeper</strong> - 集中的基础架构和协调服务</td>
<td><a target="_blank" rel="noopener" href="https://dunwu.github.io/bigdata-tutorial/zookeeper/">ZooKeeper</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="我上我也行系列"><a class="markdownIt-Anchor" href="#我上我也行系列"></a> 我上我也行系列</h3>
<h4 id="设计一个短地址服务"><a class="markdownIt-Anchor" href="#设计一个短地址服务"></a> <a href="docs/01.%E6%9E%B6%E6%9E%84/01.%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E7%9F%AD%E5%9C%B0%E5%9D%80%E6%9C%8D%E5%8A%A1.md">设计一个短地址服务</a></h4>
<h4 id="设计一个低代码平台"><a class="markdownIt-Anchor" href="#设计一个低代码平台"></a> <a href="docs/01.%E6%9E%B6%E6%9E%84/01.%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E4%BD%8E%E4%BB%A3%E7%A0%81%E5%B9%B3%E5%8F%B0.md">设计一个低代码平台</a></h4>
<h2 id="资料"><a class="markdownIt-Anchor" href="#资料"></a> 📚 资料</h2>
<h2 id="传送"><a class="markdownIt-Anchor" href="#传送"></a> 🚪 传送</h2>
<p>◾ 🏠 <a target="_blank" rel="noopener" href="https://github.com/dunwu/design">DESIGN 首页</a> ◾ 🎯 <a target="_blank" rel="noopener" href="https://github.com/dunwu/blog">我的博客</a> ◾</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/38f2de7d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/38f2de7d.html" class="post-title-link" itemprop="url">亚马逊的架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" itemprop="url" rel="index"><span itemprop="name">解决方案</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/38f2de7d.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="38f2de7d.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>160</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="亚马逊的架构"><a class="markdownIt-Anchor" href="#亚马逊的架构"></a> 亚马逊的架构</h1>
<h2 id="摘录的要点"><a class="markdownIt-Anchor" href="#摘录的要点"></a> 摘录的要点</h2>
<p>可扩展：添加资源，性能成正比提升</p>
<p>分布式、去中心化</p>
<p>隔离性：面向服务，聚合数以百计的服务，对外统一提供服务</p>
<p>同时支持 REST 和 SOAP</p>
<p>团队在精不在多，节省沟通成本</p>
<p>状态管理是大规模系统的核心问题，如分布式 Session 等</p>
<p>设计应尽量简单，很多问题可以用业务逻辑去解决，而不是通过技术</p>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/amazon-architecture">Amazon 的架构</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/62b56ef9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/62b56ef9.html" class="post-title-link" itemprop="url">短地址服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" itemprop="url" rel="index"><span itemprop="name">解决方案</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/62b56ef9.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="62b56ef9.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="设计-pastebincom-或者-bitly"><a class="markdownIt-Anchor" href="#设计-pastebincom-或者-bitly"></a> 设计 <a target="_blank" rel="noopener" href="http://Pastebin.com">Pastebin.com</a> (或者 <a target="_blank" rel="noopener" href="http://Bit.ly">Bit.ly</a>)</h1>
<blockquote>
<p>本文搬运自 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README-zh-Hans.md">设计 Pastebin.com (或者 Bit.ly)</a></p>
</blockquote>
<p><strong>注意: 为了避免重复，当前文档会直接链接到<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题</a>的相关区域，请参考链接内容以获得综合的讨论点、权衡和替代方案。</strong></p>
<p><strong>设计 <a target="_blank" rel="noopener" href="http://Bit.ly">Bit.ly</a></strong> - 是一个类似的问题，区别是 pastebin 需要存储的是 paste 的内容，而不是原始的未短化的 url。</p>
<h2 id="步骤一-需求分析"><a class="markdownIt-Anchor" href="#步骤一-需求分析"></a> 步骤一、需求分析</h2>
<blockquote>
<p>收集这个问题的需求和范畴。<br />
问相关问题来明确用例和约束。<br />
讨论一些假设。</p>
</blockquote>
<h3 id="用例"><a class="markdownIt-Anchor" href="#用例"></a> 用例</h3>
<h4 id="问题范围"><a class="markdownIt-Anchor" href="#问题范围"></a> 问题范围</h4>
<ul>
<li><strong>用户</strong> 输入一段文本，然后得到一个随机生成的链接
<ul>
<li>过期设置
<ul>
<li>默认的设置是不会过期的</li>
<li>可以选择设置一个过期的时间</li>
</ul>
</li>
</ul>
</li>
<li><strong>用户</strong> 输入一个 paste 的 url 后，可以看到它存储的内容</li>
<li><strong>用户</strong> 是匿名的</li>
<li><strong>Service</strong> 跟踪页面分析
<ul>
<li>一个月的访问统计</li>
</ul>
</li>
<li><strong>Service</strong> 删除过期的 pastes</li>
<li><strong>Service</strong> 需要高可用</li>
</ul>
<h4 id="超出范畴的用例"><a class="markdownIt-Anchor" href="#超出范畴的用例"></a> 超出范畴的用例</h4>
<ul>
<li><strong>用户</strong> 可以注册一个账户
<ul>
<li><strong>用户</strong> 通过验证邮箱</li>
</ul>
</li>
<li><strong>用户</strong> 可以用注册的账户登录
<ul>
<li><strong>用户</strong> 可以编辑文档</li>
</ul>
</li>
<li><strong>用户</strong> 可以设置可见性</li>
<li><strong>用户</strong> 可以设置短链接</li>
</ul>
<h3 id="约束和假设"><a class="markdownIt-Anchor" href="#约束和假设"></a> 约束和假设</h3>
<h4 id="状态假设"><a class="markdownIt-Anchor" href="#状态假设"></a> 状态假设</h4>
<ul>
<li>访问流量不是均匀分布的</li>
<li>打开一个短链接应该是很快的</li>
<li>pastes 只能是文本</li>
<li>页面访问分析数据可以不用实时</li>
<li>一千万的用户量</li>
<li>每个月一千万的 paste 写入量</li>
<li>每个月一亿的 paste 读取量</li>
<li>读写比例在 10:1</li>
</ul>
<h4 id="性能估算"><a class="markdownIt-Anchor" href="#性能估算"></a> 性能估算</h4>
<ul>
<li>每个 paste 的大小
<ul>
<li>每一个 paste 1 KB</li>
<li><code>shortlink</code> - 7 bytes</li>
<li><code>expiration_length_in_minutes</code> - 4 bytes</li>
<li><code>created_at</code> - 5 bytes</li>
<li><code>paste_path</code> - 255 bytes</li>
<li>总共 = ~1.27 KB</li>
</ul>
</li>
<li>每个月新的 paste 内容在 12.7GB
<ul>
<li>(1.27 * 10000000)KB / 月的 paste</li>
<li>三年内将近 450GB 的新 paste 内容</li>
<li>三年内 3.6 亿短链接</li>
<li>假设大部分都是新的 paste，而不是需要更新已存在的 paste</li>
</ul>
</li>
<li>平均 4paste/s 的写入速度</li>
<li>平均 40paste/s 的读取速度</li>
</ul>
<p>简单的转换指南:</p>
<ul>
<li>2.5 百万 req/s</li>
<li>1 req/s = 2.5 百万 req/month</li>
<li>40 req/s = 1 亿 req/month</li>
<li>400 req/s = 10 亿 req/month</li>
</ul>
<h2 id="步骤二-顶层设计"><a class="markdownIt-Anchor" href="#步骤二-顶层设计"></a> 步骤二、顶层设计</h2>
<blockquote>
<p>概述一个包括所有重要的组件的高层次设计</p>
</blockquote>
<p><img src="http://i.imgur.com/BKsBnmG.png" alt="Imgur" /></p>
<h2 id="步骤三-核心组件设计"><a class="markdownIt-Anchor" href="#步骤三-核心组件设计"></a> 步骤三、核心组件设计</h2>
<blockquote>
<p>深入每一个核心组件的细节</p>
</blockquote>
<h3 id="用例用户输入一段文本然后得到一个随机生成的链接"><a class="markdownIt-Anchor" href="#用例用户输入一段文本然后得到一个随机生成的链接"></a> 用例：用户输入一段文本，然后得到一个随机生成的链接</h3>
<p>我们可以用一个 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Frdbms">关系型数据库</a>作为一个大的哈希表，用来把生成的 url 映射到一个包含 paste 文件的文件服务器和路径上。</p>
<p>为了避免托管一个文件服务器，我们可以用一个托管的<strong>对象存储</strong>，比如 Amazon 的 S3 或者<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">NoSQL 文档类型存储</a>。</p>
<p>作为一个大的哈希表的关系型数据库的替代方案，我们可以用<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">NoSQL 键值存储</a>。我们需要讨论<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">选择 SQL 或 NoSQL 之间的权衡</a>。下面的讨论是使用关系型数据库方法。</p>
<ul>
<li><strong>客户端</strong> 发送一个创建 paste 的请求到作为一个<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理</a>启动的 <strong>Web 服务器</strong>。</li>
<li><strong>Web 服务器</strong> 转发请求给 <strong>写接口</strong> 服务器</li>
<li><strong>写接口</strong> 服务器执行如下操作：
<ul>
<li>生成一个唯一的 url
<ul>
<li>检查这个 url 在 <strong>SQL 数据库</strong> 里面是否是唯一的</li>
<li>如果这个 url 不是唯一的，生成另外一个 url</li>
<li>如果我们支持自定义 url，我们可以使用用户提供的 url（也需要检查是否重复）</li>
</ul>
</li>
<li>把生成的 url 存储到 <strong>SQL 数据库</strong> 的 <code>pastes</code> 表里面</li>
<li>存储 paste 的内容数据到 <strong>对象存储</strong> 里面</li>
<li>返回生成的 url</li>
</ul>
</li>
</ul>
<p><strong>向面试官阐明你需要写多少代码</strong></p>
<p><code>pastes</code> 表可以有如下结构：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">shortlink <span class="type">char</span>(<span class="number">7</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">expiration_length_in_minutes <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">created_at datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">paste_path <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">PRIMARY</span> KEY(shortlink)</span><br></pre></td></tr></table></figure>
<p>我们将在 <code>shortlink</code> 字段和 <code>created_at</code> 字段上创建一个<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BD%BF%E7%94%A8%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%B4%A2%E5%BC%95">数据库索引</a>，用来提高查询的速度（避免因为扫描全表导致的长时间查询）并将数据保存在内存中，从内存里面顺序读取 1MB 的数据需要大概 250 微秒，而从 SSD 上读取则需要花费 4 倍的时间，从硬盘上则需要花费 80 倍的时间。<sup><a href=https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#每个程序员都应该知道的延迟数 > 1</a></sup></p>
<p>为了生成唯一的 url，我们可以：</p>
<ul>
<li>使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/MD5"><strong>MD5</strong></a> 来哈希用户的 IP 地址 + 时间戳
<ul>
<li>MD5 是一个普遍用来生成一个 128-bit 长度的哈希值的一种哈希方法</li>
<li>MD5 是一致分布的</li>
<li>或者我们也可以用 MD5 哈希一个随机生成的数据</li>
</ul>
</li>
<li>用 <a target="_blank" rel="noopener" href="https://www.kerstner.at/2012/07/shortening-strings-using-base-62-encoding/"><strong>Base 62</strong></a> 编码 MD5 哈希值
<ul>
<li>对于 urls，使用 Base 62 编码 <code>[a-zA-Z0-9]</code> 是比较合适的</li>
<li>对于每一个原始输入只会有一个 hash 结果，Base 62 是确定的（不涉及随机性）</li>
<li>Base 64 是另外一个流行的编码方案，但是对于 urls，会因为额外的 <code>+</code> 和 <code>-</code> 字符串而产生一些问题</li>
<li>以下 <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/742013/how-to-code-a-url-shortener">Base 62 伪代码</a> 执行的时间复杂度是 O(k)，k 是数字的数量 = 7：</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">base_encode</span>(<span class="params">num, base=<span class="number">62</span></span>):</span><br><span class="line">    digits = []</span><br><span class="line">    <span class="keyword">while</span> num &gt; <span class="number">0</span></span><br><span class="line">      remainder = modulo(num, base)</span><br><span class="line">      digits.push(remainder)</span><br><span class="line">      num = divide(num, base)</span><br><span class="line">    digits = digits.reverse</span><br></pre></td></tr></table></figure>
<ul>
<li>取输出的前 7 个字符，结果会有 62^7 个可能的值，应该足以满足在 3 年内处理 3.6 亿个短链接的约束：</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = base_encode(md5(ip_address+timestamp))[:URL_LENGTH]</span><br></pre></td></tr></table></figure>
<p>我们将会用一个公开的 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest"><strong>REST 风格接口</strong></a>：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X POST --data <span class="string">&#x27;&#123;&quot;expiration_length_in_minutes&quot;:&quot;60&quot;, \&quot;paste_contents&quot;:&quot;Hello World!&quot;&#125;&#x27;</span> https://pastebin.com/api/v1/paste</span></span><br></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;shortlink&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foobar&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>用于内部通信，我们可以用 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a>。</p>
<h3 id="用例用户输入一个-paste-的-url-后可以看到它存储的内容"><a class="markdownIt-Anchor" href="#用例用户输入一个-paste-的-url-后可以看到它存储的内容"></a> 用例：用户输入一个 paste 的 url 后可以看到它存储的内容</h3>
<ul>
<li><strong>客户端</strong> 发送一个获取 paste 请求到 <strong>Web Server</strong></li>
<li><strong>Web Server</strong> 转发请求给 <strong>读取接口</strong> 服务器</li>
<li><strong>读取接口</strong> 服务器执行如下操作：
<ul>
<li>在 <strong>SQL 数据库</strong> 检查这个生成的 url
<ul>
<li>如果这个 url 在 <strong>SQL 数据库</strong> 里面，则从 <strong>对象存储</strong> 获取这个 paste 的内容</li>
<li>否则，返回一个错误页面给用户</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>REST API：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl https://pastebin.com/api/v1/paste?shortlink=foobar</span><br></pre></td></tr></table></figure>
<p>Response:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;paste_contents&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello World&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YYYY-MM-DD HH:MM:SS&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;expiration_length_in_minutes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="用例-服务跟踪分析页面"><a class="markdownIt-Anchor" href="#用例-服务跟踪分析页面"></a> 用例： 服务跟踪分析页面</h3>
<p>因为实时分析不是必须的，所以我们可以简单的 <strong>MapReduce</strong> <strong>Web Server</strong> 的日志，用来生成点击次数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HitCounts</span>(<span class="title class_ inherited__">MRJob</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_url</span>(<span class="params">self, line</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Extract the generated url from the log line.&quot;&quot;&quot;</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_year_month</span>(<span class="params">self, line</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return the year and month portions of the timestamp.&quot;&quot;&quot;</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mapper</span>(<span class="params">self, _, line</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Parse each log line, extract and transform relevant lines.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Emit key value pairs of the form:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (2016-01, url0), 1</span></span><br><span class="line"><span class="string">        (2016-01, url0), 1</span></span><br><span class="line"><span class="string">        (2016-01, url1), 1</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        url = self.extract_url(line)</span><br><span class="line">        period = self.extract_year_month(line)</span><br><span class="line">        <span class="keyword">yield</span> (period, url), <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reducer</span>(<span class="params">self, key, values</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Sum values for each key.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (2016-01, url0), 2</span></span><br><span class="line"><span class="string">        (2016-01, url1), 1</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">yield</span> key, <span class="built_in">sum</span>(values)</span><br></pre></td></tr></table></figure>
<h3 id="用例-服务删除过期的-pastes"><a class="markdownIt-Anchor" href="#用例-服务删除过期的-pastes"></a> 用例： 服务删除过期的 pastes</h3>
<p>为了删除过期的 pastes，我们可以直接搜索 <strong>SQL 数据库</strong> 中所有的过期时间比当前时间更早的记录，<br />
所有过期的记录将从这张表里面删除（或者将其标记为过期）。</p>
<h2 id="步骤四-扩展设计"><a class="markdownIt-Anchor" href="#步骤四-扩展设计"></a> 步骤四、扩展设计</h2>
<blockquote>
<p>给定约束条件，识别和解决瓶颈。</p>
</blockquote>
<p><img src="http://i.imgur.com/4edXG0T.png" alt="Imgur" /></p>
<p><strong>重要提示: 不要简单的从最初的设计直接跳到最终的设计</strong></p>
<p>说明您将迭代地执行这样的操作：1)<strong>Benchmark/Load 测试</strong>，2)<strong>Profile</strong> 出瓶颈，3)在评估替代方案和权衡时解决瓶颈，4)重复前面，可以参考<a href="../scaling_aws/README.md">在 AWS 上设计一个可以支持百万用户的系统</a>这个用来解决如何迭代地扩展初始设计的例子。</p>
<p>重要的是讨论在初始设计中可能遇到的瓶颈，以及如何解决每个瓶颈。比如，在多个 <strong>Web 服务器</strong> 上添加 <strong>负载平衡器</strong> 可以解决哪些问题？ <strong>CDN</strong> 解决哪些问题？<strong>Master-Slave Replicas</strong> 解决哪些问题? 替代方案是什么和怎么对每一个替代方案进行权衡比较？</p>
<p>我们将介绍一些组件来完成设计，并解决可伸缩性问题。内部的负载平衡器并不能减少杂乱。</p>
<p><strong>为了避免重复的讨论</strong>， 参考以下<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题</a>获取主要讨论要点、权衡和替代方案：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F">DNS</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%E7%BD%91%E7%BB%9Ccdn">CDN</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">负载均衡器</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95">水平扩展</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理（web 服务器）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E5%B1%82">应用层</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98">缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Frdbms">关系型数据库管理系统 (RDBMS)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2">SQL write master-slave failover</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%BC%8F">一致性模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F">可用性模式</a></li>
</ul>
<p><strong>分析存储数据库</strong> 可以用比如 Amazon Redshift 或者 Google BigQuery 这样的数据仓库解决方案。</p>
<p>一个像 Amazon S3 这样的 <strong>对象存储</strong>，可以轻松处理每月 12.7 GB 的新内容约束。</p>
<p>要处理 <em>平均</em> 每秒 40 读请求(峰值更高)，其中热点内容的流量应该由 <strong>内存缓存</strong> 处理，而不是数据库。<strong>内存缓存</strong> 对于处理分布不均匀的流量和流量峰值也很有用。只要副本没有陷入复制写的泥潭，<strong>SQL Read Replicas</strong> 应该能够处理缓存丢失。</p>
<p>对于单个 <strong>SQL Write Master-Slave</strong>，<em>平均</em> 每秒 4paste 写入 (峰值更高) 应该是可以做到的。否则，我们需要使用额外的 SQL 扩展模式:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96">非规范化</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#SQL%E8%B0%83%E4%BC%98">SQL 调优</a></li>
</ul>
<p>我们还应该考虑将一些数据移动到 <strong>NoSQL 数据库</strong>。</p>
<h2 id="额外的话题"><a class="markdownIt-Anchor" href="#额外的话题"></a> 额外的话题</h2>
<blockquote>
<p>是否更深入探讨额外主题，取决于问题的范围和面试剩余的时间。</p>
</blockquote>
<h3 id="nosql"><a class="markdownIt-Anchor" href="#nosql"></a> NoSQL</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">键值存储</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">文档存储</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8">列型存储</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93">图数据库</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">sql 还是 nosql</a></li>
</ul>
<h3 id="缓存"><a class="markdownIt-Anchor" href="#缓存"></a> 缓存</h3>
<ul>
<li>在哪缓存
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98">客户端缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E7%BC%93%E5%AD%98">CDN 缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98">Web 服务器缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98">数据库缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98">应用缓存</a></li>
</ul>
</li>
<li>缓存什么
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">数据库查询级别的缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">对象级别的缓存</a></li>
</ul>
</li>
<li>何时更新缓存
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F">直写模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F">回写模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%B7%E6%96%B0">刷新</a></li>
</ul>
</li>
</ul>
<h3 id="异步和微服务"><a class="markdownIt-Anchor" href="#异步和微服务"></a> 异步和微服务</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97">任务队列</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%83%8C%E5%8E%8B">背压</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a></li>
</ul>
<h3 id="通信"><a class="markdownIt-Anchor" href="#通信"></a> 通信</h3>
<ul>
<li>讨论权衡:
<ul>
<li>跟客户端之间的外部通信 - <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">HTTP APIs following REST</a></li>
<li>内部通信 - <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li>
</ul>
<h3 id="安全"><a class="markdownIt-Anchor" href="#安全"></a> 安全</h3>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%89%E5%85%A8">安全</a>。</p>
<h3 id="延迟数字"><a class="markdownIt-Anchor" href="#延迟数字"></a> 延迟数字</h3>
<p>见<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AF%8F%E4%B8%AA%E7%A8%8B%E5%BA%8F%E5%91%98%E9%83%BD%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%95%B0">每个程序员都应该知道的延迟数</a>。</p>
<h3 id="持续进行"><a class="markdownIt-Anchor" href="#持续进行"></a> 持续进行</h3>
<ul>
<li>继续对系统进行基准测试和监控，以在瓶颈出现时解决它们</li>
<li>扩展是一个迭代的过程</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ichunhui.github.io/cebcf098.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar2.gif">
      <meta itemprop="name" content="Jimmy">
      <meta itemprop="description" content="不忘初心，方得始终.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/cebcf098.html" class="post-title-link" itemprop="url">认证和授权</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-06 18:42:50" itemprop="dateModified" datetime="2022-06-06T18:42:50+08:00">2022-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9E%B6%E6%9E%84/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/cebcf098.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="cebcf098.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="认证和授权"><a class="markdownIt-Anchor" href="#认证和授权"></a> 认证和授权</h1>
<blockquote>
<p>关键词：SSO、Oauth 2.0、CAS、RABC、JWT</p>
</blockquote>
<h2 id="基本概念"><a class="markdownIt-Anchor" href="#基本概念"></a> 基本概念</h2>
<h3 id="认证"><a class="markdownIt-Anchor" href="#认证"></a> 认证</h3>
<p>认证是指根据声明者所特有的识别信息，确认声明者的身份。认证在英文中对应于 identification 这个单词。</p>
<p>最常见的认证实现方式是通过用户名和密码，但认证方式不限于此。下面都是当前常见到的认证技术：</p>
<ul>
<li>身份证</li>
<li>用户名和密码认证</li>
<li>用户手机认证：手机短信、手机二维码扫描、手势密码</li>
<li>用户邮箱认证</li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6238">基于时间序列和用户相关的一次性口令</a></li>
<li>用户的生物学特征认证：指纹、语音、眼睛虹膜</li>
<li>用户的大数据识别认证</li>
<li>等等</li>
</ul>
<p>为了确认用户的身份，防止伪造，在安全要求高的场合，经常会使用组合认证（或者叫多因素认证），也就是同时使用多个认证方式对用户的身份进行校验。</p>
<h3 id="授权"><a class="markdownIt-Anchor" href="#授权"></a> 授权</h3>
<p>简单来说，授权一般是指获取用户的委派权限。在英文中对应于 authorization 这个单词。</p>
<p>在信息安全领域，授权是指资源所有者委派执行者，赋予执行者指定范围的资源操作权限，以便执行者代理执行对资源的相关操作。这里面包含有如下四个重要概念，</p>
<ul>
<li><strong>资源所有者</strong>：拥有资源的所有权利，一般就是资源的拥有者。</li>
<li><strong>资源执行者</strong>：被委派去执行资源的相关操作。</li>
<li><strong>操作权限</strong>：可以对资源进行的某种操作。</li>
<li><strong>资源</strong>：有价值的信息或数据等，受到安全保护。</li>
</ul>
<p>需要说明的是，资源所有者和执行者可以是自然人，就是普通用户，但不限于自然人。在信息安全领域，资源所有者和执行者，很多时候是应用程序或者机器。比如用户在浏览器上登录一个网站，那么这个浏览器就成为一个执行者，它在用户登录后获取了用户的授权，代表着用户执行各种指令，进行购物、下单、付钱、转账等等操作。</p>
<p>同时，资源所有者和执行者可以是分开的不同实体，也可以是同一个。若是分开的两者，则资源执行者是以资源所有者的代理形式而存在。</p>
<p>授权的实现方式非常多也很广泛，我们常见的银行卡、门禁卡、钥匙、公证书，这些都是现实生活中授权的实现方式。其实现方式主要通过一个共信的媒介完成，这个媒介不可被篡改，不可随意伪造，很多时候需要受保护，防止被窃取。</p>
<p>在互联网应用开发领域，授权所用到的授信媒介主要包括如下几种，</p>
<ul>
<li>通过 web 服务器的 session 机制，一个访问会话保持着用户的授权信息</li>
<li>通过 web 浏览器的 cookie 机制，一个网站的 cookie 保持着用户的授权信息</li>
<li>颁发授权令牌（token），一个合法有效的令牌中保持着用户的授权信息</li>
</ul>
<p>前面两者常见于 web 开发，需要有浏览器的支持。</p>
<h3 id="鉴权"><a class="markdownIt-Anchor" href="#鉴权"></a> 鉴权</h3>
<p>鉴权是指对于一个声明者所声明的身份权利，对其所声明的真实性进行鉴别确认的过程。在英文中对应于 authentication 这个单词。</p>
<p>鉴权主要是对声明者所声明的真实性进行校验。若从授权出发，则会更加容易理解鉴权。授权和鉴权是两个上下游相匹配的关系，先授权，后鉴权。授权和鉴权两个词中的“权”，是同一个概念，就是所委派的权利，在实现上即为授信媒介的表达形式。</p>
<p>因此，鉴权的实现方式是和授权方式有一一对应关系。对授权所颁发授信媒介进行解析，确认其真实性。下面是鉴权的一些实现方式，</p>
<ul>
<li>门禁卡：通过门禁卡识别器</li>
<li>钥匙：通过相匹配的锁</li>
<li>银行卡：通过银行卡识别器</li>
<li>互联网 web 开发领域的 session/cookie/token：校验 session/cookie/token 的合法性和有效性</li>
</ul>
<p>鉴权是一个承上启下的一个环节，上游它接受授权的输出，校验其真实性后，然后获取权限（permission），这个将会为下一步的权限控制做好准备。</p>
<h3 id="权限控制"><a class="markdownIt-Anchor" href="#权限控制"></a> 权限控制</h3>
<p>权限控制是指对可执行的各种操作组合配置为权限列表，然后根据执行者的权限，若其操作在权限范围内，则允许执行，否则禁止。权限控制在英文中对应于 access/permission control。</p>
<p>对于权限控制，可以分为两部分进行理解：一个是权限，另一个是控制。权限是抽象的逻辑概念，而控制是具体的实现方式。</p>
<p>先看权限（Permission），这是一个抽象的概念，一般预先定义和配置好，以便控制的具体实现。权限的定义，若简单点，可以直接对应于一个可执行的操作集合。而一般情况下，会有基于角色的方式来定义权限，由角色来封装可执行的操作集合。</p>
<p>若以门禁卡的权限实现为例，上述两种定义方式则可以各自表达为，</p>
<ul>
<li>这是一个门禁卡，拥有开公司所有的门的权限</li>
<li>这是一个门禁卡，拥有管理员角色的权限，因而可以开公司所有的门</li>
</ul>
<p>可以看到，权限作为一个抽象的概念，将执行者和可具体执行的操作相分离。</p>
<p>在上文的讨论中，鉴权的输出是权限（Permission）。一旦有了权限，便知道了可执行的操作，接下来就是控制的事情了。</p>
<p>对于控制，是根据执行者的权限，对其所执行的操作进行判断，决定允许或禁止当前操作的执行。现实生活中控制的实现方式，多种多样，</p>
<ul>
<li>门禁：控制门的开关</li>
<li>自行车锁：控制车轮</li>
<li>互联网 web 后端服务：控制接口访问，允许或拒绝访问请求</li>
</ul>
<h3 id="认证-授权-鉴权和权限控制的关系"><a class="markdownIt-Anchor" href="#认证-授权-鉴权和权限控制的关系"></a> 认证、授权、鉴权和权限控制的关系</h3>
<p>认证、授权、鉴权和权限控制这四个环节是一个前后依次发生、上下游的关系，</p>
<p>认证–&gt;授权–&gt;鉴权–&gt;权限控制</p>
<p>需要说明的是，这四个环节在有些时候会同时发生。 例如在下面的几个场景，</p>
<ul>
<li>使用门禁卡开门：认证、授权、鉴权、权限控制四个环节一气呵成，在瞬间同时发生</li>
<li>用户的网站登录：用户在使用用户名和密码进行登录时，认证和授权两个环节一同完成，而鉴权和权限控制则发生在后续的请求访问中，比如在选购物品或支付时。</li>
</ul>
<p>无论怎样，若从时间顺序方面来看，这四个环节是按时间前后、依次相继发生的关系。</p>
<p>认证和鉴权的关系：</p>
<p>这两个概念在很多时候是被混淆最多的概念。被混淆的主要原因，如上文所述，很多时候认证、授权、鉴权和权限控制一同发生，以至于被误解为，认证就是鉴权，鉴权就是认证。</p>
<p>其实两者是不一样的概念，两者都有对身份的确认过程，但是两者的主要区别在于，</p>
<ul>
<li>认证是确认声明者的本身身份，其作为授权的上游衔接而存在</li>
<li>鉴权是对声明者所声明的真实性进行确认的过程，其作为授权的下游衔接而存在</li>
</ul>
<h2 id="jwt"><a class="markdownIt-Anchor" href="#jwt"></a> JWT</h2>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">理解 OAuth 2.0</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jimmy"
      src="/images/avatar2.gif">
  <p class="site-author-name" itemprop="name">Jimmy</p>
  <div class="site-description" itemprop="description">不忘初心，方得始终.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">192</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">114</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ichunhui" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ichunhui" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hustzch@163.com" title="E-Mail → mailto:hustzch@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">鄂ICP备17019300号-2 </a>
  </div>

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-paper-plane"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jimmy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">16:19</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://jimmyblog-2.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
